Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 20-Oct-16     22:43:47     page:   1


PC     Object              I  Line    Source 
                           A     1    ; Zilog Z8 Encore! ANSI C Compiler Release 3.62
                           A     2    ; -nolocalcse -optsize -fastcall -const=RAM -mo
                           A     3    ; -nooptlink -regvar -reduceopt -debug -norevaa
                           A     4    ; -alias 
                           A     5    	DEFINE i2c_TEXT,SPACE=ROM
                           A     6    	FILE	"..\..\..\..\DOCUME~1\GITHUB\THIRDY
                           A     7    .debug "C"
                           A     8    	SEGMENT FAR_DATA
000000                     A     9    _inChar:
000000 00                  A    10    	DB	0
                           A    11    .define "inChar"
                           A    12    .alias "_inChar"
                           A    13    .class 69
                           A    14    .value _inChar
                           A    15    .type 2
                           A    16    .type 0
                           A    17    .endef
                           A    18    	SEGMENT i2c_TEXT
                           A    19    .begrec "fmt_type",16
                           A    20    .define "status"
                           A    21    .value 0
                           A    22    .class 8
                           A    23    .type 12
                           A    24    .type 0
                           A    25    .endef
                           A    26    .define "flags"
                           A    27    .value 1
                           A    28    .class 8
                           A    29    .type 12
                           A    30    .type 0
                           A    31    .endef
                           A    32    .define "size"
                           A    33    .value 2
                           A    34    .class 8
                           A    35    .type 2
                           A    36    .type 0
                           A    37    .endef
                           A    38    .define "chr"
                           A    39    .value 3
                           A    40    .class 8
                           A    41    .type 2
                           A    42    .type 0
                           A    43    .endef
                           A    44    .define "type"
                           A    45    .value 4
                           A    46    .class 8
                           A    47    .type 2
                           A    48    .type 0
                           A    49    .endef
                           A    50    .define "field_width"
                           A    51    .value 5
                           A    52    .class 8
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 20-Oct-16     22:43:47     page:   2


PC     Object              I  Line    Source i2c.src
                           A    53    .type 2
                           A    54    .type 0
                           A    55    .endef
                           A    56    .define "precision"
                           A    57    .value 6
                           A    58    .class 8
                           A    59    .type 2
                           A    60    .type 0
                           A    61    .endef
                           A    62    .define "set_begin"
                           A    63    .value 7
                           A    64    .class 8
                           A    65    .type 162
                           A    66    .type 0
                           A    67    .endef
                           A    68    .define "set_end"
                           A    69    .value 9
                           A    70    .class 8
                           A    71    .type 162
                           A    72    .type 0
                           A    73    .endef
                           A    74    .define "pad_whole"
                           A    75    .value 11
                           A    76    .class 8
                           A    77    .type 12
                           A    78    .type 0
                           A    79    .endef
                           A    80    .define "pad_pre_fract"
                           A    81    .value 12
                           A    82    .class 8
                           A    83    .type 12
                           A    84    .type 0
                           A    85    .endef
                           A    86    .define "pad_post_fract"
                           A    87    .value 13
                           A    88    .class 8
                           A    89    .type 12
                           A    90    .type 0
                           A    91    .endef
                           A    92    .define "pad_at"
                           A    93    .value 14
                           A    94    .class 8
                           A    95    .type 162
                           A    96    .type 0
                           A    97    .endef
                           A    98    .endrec "fmt_type"
                           A    99    .begrec "flt_info",12
                           A   100    .define "flags"
                           A   101    .value 0
                           A   102    .class 8
                           A   103    .type 12
                           A   104    .type 0
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 20-Oct-16     22:43:47     page:   3


PC     Object              I  Line    Source i2c.src
                           A   105    .endef
                           A   106    .define "exp"
                           A   107    .value 1
                           A   108    .class 8
                           A   109    .type 2
                           A   110    .type 0
                           A   111    .endef
                           A   112    .define "digits"
                           A   113    .value 2
                           A   114    .class 8
                           A   115    .dim 10
                           A   116    .type 108
                           A   117    .type 0
                           A   118    .endef
                           A   119    .endrec "flt_info"
                           A   120    	SEGMENT FAR_BSS
000000                     A   121    _string:
000000                     A   122    	DS	25
                           A   123    .define "string"
                           A   124    .alias "_string"
                           A   125    .class 83
                           A   126    .value _string
                           A   127    .dim 25
                           A   128    .type 98
                           A   129    .type 0
                           A   130    .endef
                           A   131    	SEGMENT FAR_DATA
000001                     A   132    _txFinished:
000001 01                  A   133    	DB	1
                           A   134    .define "txFinished"
                           A   135    .alias "_txFinished"
                           A   136    .class 69
                           A   137    .value _txFinished
                           A   138    .type 2
                           A   139    .type 0
                           A   140    .endef
000002                     A   141    _command:
000002 00                  A   142    	DB	0
                           A   143    .define "command"
                           A   144    .alias "_command"
                           A   145    .class 69
                           A   146    .value _command
                           A   147    .type 2
                           A   148    .type 0
                           A   149    .endef
000003                     A   150    _rxFlag:
000003 00                  A   151    	DB	0
                           A   152    .define "rxFlag"
                           A   153    .alias "_rxFlag"
                           A   154    .class 69
                           A   155    .value _rxFlag
                           A   156    .type 2
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 20-Oct-16     22:43:47     page:   4


PC     Object              I  Line    Source i2c.src
                           A   157    .type 0
                           A   158    .endef
                           A   159    	SEGMENT FAR_BSS
000019                     A   160    _gyroRead:
000019                     A   161    	DS	2
                           A   162    .define "gyroRead"
                           A   163    .alias "_gyroRead"
                           A   164    .class 83
                           A   165    .value _gyroRead
                           A   166    .dim 2
                           A   167    .type 98
                           A   168    .type 0
                           A   169    .endef
00001B                     A   170    _accRead:
00001B                     A   171    	DS	6
                           A   172    .define "accRead"
                           A   173    .alias "_accRead"
                           A   174    .class 83
                           A   175    .value _accRead
                           A   176    .dim 6
                           A   177    .type 98
                           A   178    .type 0
                           A   179    .endef
000021                     A   180    _acc_xh:
000021                     A   181    	DS	1
                           A   182    .define "acc_xh"
                           A   183    .alias "_acc_xh"
                           A   184    .class 83
                           A   185    .value _acc_xh
                           A   186    .type 2
                           A   187    .type 0
                           A   188    .endef
000022                     A   189    _acc_xl:
000022                     A   190    	DS	1
                           A   191    .define "acc_xl"
                           A   192    .alias "_acc_xl"
                           A   193    .class 83
                           A   194    .value _acc_xl
                           A   195    .type 2
                           A   196    .type 0
                           A   197    .endef
000023                     A   198    _acc_yh:
000023                     A   199    	DS	1
                           A   200    .define "acc_yh"
                           A   201    .alias "_acc_yh"
                           A   202    .class 83
                           A   203    .value _acc_yh
                           A   204    .type 2
                           A   205    .type 0
                           A   206    .endef
000024                     A   207    _acc_yl:
000024                     A   208    	DS	1
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 20-Oct-16     22:43:47     page:   5


PC     Object              I  Line    Source i2c.src
                           A   209    .define "acc_yl"
                           A   210    .alias "_acc_yl"
                           A   211    .class 83
                           A   212    .value _acc_yl
                           A   213    .type 2
                           A   214    .type 0
                           A   215    .endef
000025                     A   216    _acc_y:
000025                     A   217    	DS	1
                           A   218    .define "acc_y"
                           A   219    .alias "_acc_y"
                           A   220    .class 83
                           A   221    .value _acc_y
                           A   222    .type 2
                           A   223    .type 0
                           A   224    .endef
000026                     A   225    _acc_x:
000026                     A   226    	DS	1
                           A   227    .define "acc_x"
                           A   228    .alias "_acc_x"
                           A   229    .class 83
                           A   230    .value _acc_x
                           A   231    .type 2
                           A   232    .type 0
                           A   233    .endef
000027                     A   234    _gyro_h:
000027                     A   235    	DS	1
                           A   236    .define "gyro_h"
                           A   237    .alias "_gyro_h"
                           A   238    .class 83
                           A   239    .value _gyro_h
                           A   240    .type 2
                           A   241    .type 0
                           A   242    .endef
000028                     A   243    _gyro_l:
000028                     A   244    	DS	1
                           A   245    .define "gyro_l"
                           A   246    .alias "_gyro_l"
                           A   247    .class 83
                           A   248    .value _gyro_l
                           A   249    .type 2
                           A   250    .type 0
                           A   251    .endef
000029                     A   252    _gyro_val:
000029                     A   253    	DS	2*1
                           A   254    .define "gyro_val"
                           A   255    .alias "_gyro_val"
                           A   256    .class 83
                           A   257    .value _gyro_val
                           A   258    .type 3
                           A   259    .type 0
                           A   260    .endef
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 20-Oct-16     22:43:47     page:   6


PC     Object              I  Line    Source i2c.src
00002B                     A   261    _accXValue:
00002B                     A   262    	DS	2*1
                           A   263    .define "accXValue"
                           A   264    .alias "_accXValue"
                           A   265    .class 83
                           A   266    .value _accXValue
                           A   267    .type 3
                           A   268    .type 0
                           A   269    .endef
00002D                     A   270    _accYValue:
00002D                     A   271    	DS	2*1
                           A   272    .define "accYValue"
                           A   273    .alias "_accYValue"
                           A   274    .class 83
                           A   275    .value _accYValue
                           A   276    .type 3
                           A   277    .type 0
                           A   278    .endef
00002F                     A   279    _accZValue:
00002F                     A   280    	DS	2*1
                           A   281    .define "accZValue"
                           A   282    .alias "_accZValue"
                           A   283    .class 83
                           A   284    .value _accZValue
                           A   285    .type 3
                           A   286    .type 0
                           A   287    .endef
000031                     A   288    _gyroXValue:
000031                     A   289    	DS	2*1
                           A   290    .define "gyroXValue"
                           A   291    .alias "_gyroXValue"
                           A   292    .class 83
                           A   293    .value _gyroXValue
                           A   294    .type 3
                           A   295    .type 0
                           A   296    .endef
000033                     A   297    _state:
000033                     A   298    	DS	7
                           A   299    .define "state"
                           A   300    .alias "_state"
                           A   301    .class 83
                           A   302    .value _state
                           A   303    .tag "NONAME0"
                           A   304    .type 8
                           A   305    .type 0
                           A   306    .endef
                           A   307    	SEGMENT i2c_TEXT
                           A   308    .begrec "NONAME0",7
                           A   309    .define "reading"
                           A   310    .value 0
                           A   311    .class 8
                           A   312    .type 2
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 20-Oct-16     22:43:47     page:   7


PC     Object              I  Line    Source i2c.src
                           A   313    .type 0
                           A   314    .endef
                           A   315    .define "cycle"
                           A   316    .value 1
                           A   317    .class 8
                           A   318    .type 2
                           A   319    .type 0
                           A   320    .endef
                           A   321    .define "deviceAddress"
                           A   322    .value 2
                           A   323    .class 8
                           A   324    .type 12
                           A   325    .type 0
                           A   326    .endef
                           A   327    .define "registerAddress"
                           A   328    .value 3
                           A   329    .class 8
                           A   330    .type 12
                           A   331    .type 0
                           A   332    .endef
                           A   333    .define "bytesToRead"
                           A   334    .value 4
                           A   335    .class 8
                           A   336    .type 12
                           A   337    .type 0
                           A   338    .endef
                           A   339    .define "storePtr"
                           A   340    .value 5
                           A   341    .class 8
                           A   342    .type 172
                           A   343    .type 0
                           A   344    .endef
                           A   345    .endrec "NONAME0"
                           A   346    	SEGMENT ROM_DATA
                           A   347    
                           A   348    
                           A   349    ;**************************** _i2cInit ********
                           A   350    ;Name                         Addr/Register   S
                           A   351    ;_state                              STATIC    
                           A   352    ;_t1_mem_isr                         IMPORT  --
                           A   353    ;_Si2c_Isr                           IMPORT  --
                           A   354    ;_SET_VECTOR                         IMPORT  --
                           A   355    
                           A   356    
                           A   357    ; Aggregate Stack Size: 0 (words)
                           A   358    
                           A   359    
                           A   360    	.FRAME _n_i2cInit,?_n_i2cInit,RDATA
                           A   361    	.FRAME _f_i2cInit,?_f_i2cInit,EDATA
                           A   362    	SEGMENT i2c_TEXT
000000                     A   363    _i2cInit:
                           A   364    .define "_i2cInit"
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 20-Oct-16     22:43:47     page:   8


PC     Object              I  Line    Source i2c.src
                           A   365    .value _i2cInit
                           A   366    .class 2
                           A   367    .type 65
                           A   368    .type 0
                           A   369    .endef
                           A   370    .begfunc "i2cInit",72,"_i2cInit"
000000 D6 0000             A   371    	CALL	__b_frameset00
                           A   372    ;    1	// Code by Brian Bienvenu; Jim Cocks; B
                           A   373    ;    2	
                           A   374    ;    3	#include <eZ8.h>
                           A   375    ;    4	#include <STDIO.H>
                           A   376    ;    5	#include <uart.h>
                           A   377    ;    6	#include "i2c.h"
                           A   378    ;    7	#include <LCD.h>
                           A   379    ;    8	#include <STRING.H>
                           A   380    ;    9	
                           A   381    ;   10	#define FAIL (0)
                           A   382    ;   11	#define PASS (1)
                           A   383    ;   12	#define AUTO_INC (0x80)
                           A   384    ;   13	#define READ_BIT (0x01)
                           A   385    ;   14	
                           A   386    ;   15	//IC2 Interrupt Enable
                           A   387    ;   16	#define IC2_EI (0x04) //0000 0100
                           A   388    ;   17	
                           A   389    ;   18	//Z8 definitions I2CCTL
                           A   390    ;   19	#define I2CEN_MASK	(0x80)
                           A   391    ;   20	#define START_MASK 	(0x40)
                           A   392    ;   21	#define STOP_MASK  	(0x20)
                           A   393    ;   22	#define TXI_MASK	(0x08)
                           A   394    ;   23	#define NAK_MASK	(0x04)
                           A   395    ;   24	#define FLUSH_MASK 	(0x02)
                           A   396    ;   25	//I2CSTAT
                           A   397    ;   26	#define TDRE_MASK  	(0x80)
                           A   398    ;   27	#define RDRF_MASK	(0x40)
                           A   399    ;   28	#define NCKI_MASK	(0x01)
                           A   400    ;   29	
                           A   401    ;   30	
                           A   402    ;   31	typedef char enum
                           A   403    ;   32	{
                           A   404    ;   33		FAILED = -1,
                           A   405    ;   34		BUSY = 0,
                           A   406    ;   35		DONE = 1
                           A   407    ;   36	} readState_t;
                           A   408    ;   37	
                           A   409    ;   38	typedef char enum
                           A   410    ;   39	{
                           A   411    ;   40		DEV_ADDESS_WRITE,
                           A   412    ;   41		DEV_SUB_ADDRESS,
                           A   413    ;   42		START_READ,
                           A   414    ;   43		DEV_ADDESS_READ,
                           A   415    ;   44		READ_BYTE,
                           A   416    ;   45		READ_LAST,
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 20-Oct-16     22:43:47     page:   9


PC     Object              I  Line    Source i2c.src
                           A   417    ;   46		END_CYCLE
                           A   418    ;   47	} cycle_t;
                           A   419    ;   48	
                           A   420    ;   49	typedef struct
                           A   421    ;   50	{
                           A   422    ;   51		readState_t reading;
                           A   423    ;   52		cycle_t cycle;
                           A   424    ;   53		unsigned char deviceAddress;
                           A   425    ;   54		unsigned char registerAddress;
                           A   426    ;   55		unsigned char bytesToRead;
                           A   427    ;   56		unsigned char* storePtr;
                           A   428    ;   57	} i2cState_t;
                           A   429    ;   58	
                           A   430    ;   59	static i2cState_t state;
                           A   431    ;   60	//prototypes
                           A   432    ;   61	void Si2c_Isr(void);
                           A   433    ;   62	
                           A   434    ;   63	/**************************************
                           A   435    ;   64	Description:
                           A   436    ;   65		Initalises the i2c: ports, interrup
                           A   437    ;   66	Notes:
                           A   438    ;   67		doesn't perform and transactions
                           A   439    ;   68	Returns:
                           A   440    ;   69		0 <- fail, 1 pass
                           A   441    ;   70	***************************************
                           A   442    ;   71	void i2cInit(void)
                           A   443    ;   72	{
                           A   444    ;   73		//PA6 and PA7
                           A   445    ;   74		//Set Pins to I2C function
                           A   446    ;   75		PAAF |= 0xC0; 	//1100 0000
                           A   447    .line 75
000003 E9020FD0            A   448    	LDX	4048,#2
000007 49C00FD1            A   449    	ORX	4049,#192
                           A   450    ;   76	
                           A   451    ;   77		//set baud rate
                           A   452    ;   78		I2CBRH = (I2C_BAUD_DIV >> 8);
                           A   453    .line 78
00000B E9000F53            A   454    	LDX	3923,#-0
                           A   455    ;   79		I2CBRL = (I2C_BAUD_DIV & 0xFF);
                           A   456    .line 79
00000F E90C0F54            A   457    	LDX	3924,#12
                           A   458    ;   80	
                           A   459    ;   81		//clear txi
                           A   460    ;   82		I2CCTL &= ~TXI_MASK;
                           A   461    .line 82
000013 59F70F52            A   462    	ANDX	3922,#-9
                           A   463    ;   83		//disable I2C control register
                           A   464    ;   84		I2CCTL &= ~I2CEN_MASK;
                           A   465    .line 84
000017 597F0F52            A   466    	ANDX	3922,#127
                           A   467    ;   85		//set isr for I2C
                           A   468    ;   86		SET_VECTOR(I2C,Si2c_Isr);
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 20-Oct-16     22:43:47     page:  10


PC     Object              I  Line    Source i2c.src
                           A   469    ;   87		//set I2C isr to highest priority
                           A   470    ;   88		IRQ0ENH |= IC2_EI;
                           A   471    .line 88
00001B 49040FC1            A   472    	ORX	4033,#4
                           A   473    ;   89		IRQ0ENL |= IC2_EI;
                           A   474    .line 89
00001F 49040FC2            A   475    	ORX	4034,#4
                           A   476    ;   90	
                           A   477    ;   91		//Port D int1_g and int1_A interrup
                           A   478    ;   92		IRQ1ENH |= 0x03;
                           A   479    .line 92
000023 49030FC4            A   480    	ORX	4036,#3
                           A   481    ;   93		IRQ1ENL |= 0x03;
                           A   482    .line 93
000027 49030FC5            A   483    	ORX	4037,#3
                           A   484    ;   94		IRQPS |= 0x03;
                           A   485    .line 94
00002B 49030FCE            A   486    	ORX	4046,#3
                           A   487    ;   95	
                           A   488    ;   96		PCAF &= 0x02;
                           A   489    .line 96
00002F E9020FD8            A   490    	LDX	4056,#2
000033 59020FD9            A   491    	ANDX	4057,#2
                           A   492    ;   97		//set Timers to PWM mode, no presca
                           A   493    ;   98		T1CTL1 = 0x21; //CONTINUOUS_MODE | 
                           A   494    .line 98
000037 E9210F0F            A   495    	LDX	3855,#33
                           A   496    ;   99		//set reset count value to 0
                           A   497    ;  100		T1H = 0;
                           A   498    .line 100
00003B E9000F08            A   499    	LDX	3848,#-0
                           A   500    ;  101		T1L = 0;
                           A   501    .line 101
00003F E9000F09            A   502    	LDX	3849,#-0
                           A   503    ;  102		//set reload value
                           A   504    ;  103		T1RH = 0xC3; //50000
                           A   505    .line 103
000043 E9C30F0A            A   506    	LDX	3850,#195
                           A   507    ;  104		T1RL = 0x50;
                           A   508    .line 104
000047 E9500F0B            A   509    	LDX	3851,#80
                           A   510    ;  105	
                           A   511    ;  106		//T1CTL1 |= 0x80;
                           A   512    ;  107	
                           A   513    ;  108		IRQ0ENH |= 0x40;
                           A   514    .line 108
00004B 49400FC1            A   515    	ORX	4033,#64
                           A   516    ;  109		IRQ0ENL |= 0x40;
                           A   517    .line 109
00004F 49400FC2            A   518    	ORX	4034,#64
                           A   519    ;  110	
                           A   520    ;  111		SET_VECTOR(TIMER1, t1_mem_isr);
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 20-Oct-16     22:43:47     page:  11


PC     Object              I  Line    Source i2c.src
                           A   521    ;  112		//init internal state so it doesn't
                           A   522    ;  113		state.reading = DONE;
                           A   523    .line 113
000053 E9010033            A   524    	LDX	_state,#1
                           A   525    ;  114	}
                           A   526    .line 114
000057 D6 0000             A   527    	CALL	__b_framereset
00005A AF                  A   528    	RET	
                           A   529    .endfunc "i2cInit",114,"_i2cInit"
                           A   530    	SEGMENT ROM_DATA
                           A   531    
                           A   532    
                           A   533    ;**************************** _i2cWrite *******
                           A   534    ;Name                         Addr/Register   S
                           A   535    ;_EI                                 IMPORT  --
                           A   536    ;_DI                                 IMPORT  --
                           A   537    ;ret                                     R0    
                           A   538    ;dataByte                               R10    
                           A   539    ;registerAddress                         R9    
                           A   540    ;deviceAddress                           R8    
                           A   541    
                           A   542    
                           A   543    ; Aggregate Stack Size: 0 (words)
                           A   544    
                           A   545    
                           A   546    	.FRAME _n_i2cWrite,?_n_i2cWrite,RDATA
                           A   547    	.FRAME _f_i2cWrite,?_f_i2cWrite,EDATA
                           A   548    	SEGMENT i2c_TEXT
00005B                     A   549    _i2cWrite:
                           A   550    .define "_i2cWrite"
                           A   551    .value _i2cWrite
                           A   552    .class 2
                           A   553    .type 76
                           A   554    .type 0
                           A   555    .endef
                           A   556    .begfunc "i2cWrite",127,"_i2cWrite"
                           A   557    .define "deviceAddress"
                           A   558    .class 17
                           A   559    .reg 9
                           A   560    .type 12
                           A   561    .type 0
                           A   562    .endef
                           A   563    .define "registerAddress"
                           A   564    .class 17
                           A   565    .reg 10
                           A   566    .type 12
                           A   567    .type 0
                           A   568    .endef
                           A   569    .define "dataByte"
                           A   570    .class 17
                           A   571    .reg 11
                           A   572    .type 12
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 20-Oct-16     22:43:47     page:  12


PC     Object              I  Line    Source i2c.src
                           A   573    .type 0
                           A   574    .endef
                           A   575    ;  115	
                           A   576    ;  116	/**************************************
                           A   577    ;  117	Description:
                           A   578    ;  118		Performs single byte i2c write
                           A   579    ;  119	Notes:
                           A   580    ;  120		Is blocking
                           A   581    ;  121		Doesn't use interrupts
                           A   582    ;  122		Don't use while performing a read
                           A   583    ;  123	Returns:
                           A   584    ;  124		1 <= successful, 0 <= failed
                           A   585    ;  125	***************************************
                           A   586    ;  126	unsigned char i2cWrite(unsigned char de
                           A   587    ;  127	{
                           A   588    .define "U‹ìjÿh0/J"
                           A   589    .class 4
                           A   590    .reg 1
                           A   591    .type 12
                           A   592    .type 0
                           A   593    .endef
00005B D6 0000             A   594    	CALL	__b_frameset00
                           A   595    ;  128		unsigned char ret;
                           A   596    ;  129		ret = FAIL;
                           A   597    .line 129
00005E B0E0                A   598    	CLR	R0
                           A   599    ;  130		//disable interrupts
                           A   600    ;  131		DI();
                           A   601    .line 131
000060 8F                  A   602    	DI
                           A   603    ;  132		//enable I2C control register
                           A   604    ;  133		I2CCTL |= I2CEN_MASK;
                           A   605    .line 133
000061 49800F52            A   606    	ORX	3922,#128
                           A   607    ;  134	
                           A   608    ;  135		//wait till TDRE = 1
                           A   609    ;  136		while((I2CSTAT & TDRE_MASK) == 0x00
000065                     A   610    _2_L_1:
                           A   611    .line 136
000065 79800F51            A   612    	TMX	3921,#128
000069 6B FA               A   613    	JR	Z,_2_L_1
                           A   614    ;  137	
                           A   615    ;  138		//write device address to I2C data 
                           A   616    ;  139		I2CDATA = deviceAddress;
                           A   617    .line 139
00006B 948F50              A   618    	LDX	3920,R8
                           A   619    ;  140	
                           A   620    ;  141		//assert start
                           A   621    ;  142		I2CCTL |= START_MASK;
                           A   622    .line 142
00006E 49400F52            A   623    	ORX	3922,#64
                           A   624    ;  143	
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 20-Oct-16     22:43:47     page:  13


PC     Object              I  Line    Source i2c.src
                           A   625    ;  144		//wait till TDRE = 1
                           A   626    ;  145		while((I2CSTAT & TDRE_MASK) == 0x00
000072                     A   627    _2_L_4:
                           A   628    .line 145
000072 79800F51            A   629    	TMX	3921,#128
000076 6B FA               A   630    	JR	Z,_2_L_4
                           A   631    ;  146	
                           A   632    ;  147		//write device reg address to I2C d
                           A   633    ;  148		I2CDATA = registerAddress;
                           A   634    .line 148
000078 949F50              A   635    	LDX	3920,R9
                           A   636    ;  149	
                           A   637    ;  150		//wait till TDRE = 1 or error if NC
                           A   638    ;  151		while((I2CSTAT & (NCKI_MASK | TDRE_
00007B                     A   639    _2_L_7:
                           A   640    .line 151
00007B 79810F51            A   641    	TMX	3921,#129
00007F 6B FA               A   642    	JR	Z,_2_L_7
                           A   643    ;  152		if((I2CSTAT & NCKI_MASK) == 0x00)
                           A   644    .line 152
000081 79010F51            A   645    	TMX	3921,#1
000085 EB 15               A   646    	JR	NE,_2_L_16
                           A   647    ;  153		{
                           A   648    ;  154			//write dataByte to I2C data re
                           A   649    ;  155			I2CDATA = dataByte;
                           A   650    .line 155
000087 94AF50              A   651    	LDX	3920,R10
                           A   652    ;  156	
                           A   653    ;  157			//wait till TDRE = 1 or error i
                           A   654    ;  158			while((I2CSTAT & (NCKI_MASK | T
00008A                     A   655    _2_L_9:
                           A   656    .line 158
00008A 79810F51            A   657    	TMX	3921,#129
00008E 6B FA               A   658    	JR	Z,_2_L_9
                           A   659    ;  159			if((I2CSTAT & NCKI_MASK) == 0x0
                           A   660    .line 159
000090 79010F51            A   661    	TMX	3921,#1
000094 EB 06               A   662    	JR	NE,_2_L_16
                           A   663    ;  160			{
                           A   664    ;  161				//set stop bit (if got to h
                           A   665    ;  162				I2CCTL |= STOP_MASK;
                           A   666    .line 162
000096 49200F52            A   667    	ORX	3922,#32
                           A   668    ;  163				ret = PASS;
                           A   669    .line 163
00009A 0C01                A   670    	LD	R0,#1
                           A   671    ;  164			}
                           A   672    ;  165		}
00009C                     A   673    _2_L_16:
                           A   674    .line 165
                           A   675    ;  166	
                           A   676    ;  167		if(ret == FAIL)
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 20-Oct-16     22:43:47     page:  14


PC     Object              I  Line    Source i2c.src
                           A   677    .line 167
00009C 4200                A   678    	OR	R0,R0
00009E EB 04               A   679    	JR	NE,_2_L_17
                           A   680    ;  168		{
                           A   681    ;  169			//set stop and flush bits
                           A   682    ;  170			I2CCTL |= (STOP_MASK | FLUSH_MA
                           A   683    .line 170
0000A0 49220F52            A   684    	ORX	3922,#34
                           A   685    ;  171		}
0000A4                     A   686    _2_L_17:
                           A   687    .line 171
                           A   688    ;  172		//disable I2C control register
                           A   689    ;  173		//I2CCTL &= ~I2CEN_MASK;
                           A   690    ;  174		//enable interrupts
                           A   691    ;  175		EI();
                           A   692    .line 175
0000A4 9F                  A   693    	EI
                           A   694    ;  176	}
                           A   695    .line 176
0000A5 D6 0000             A   696    	CALL	__b_framereset
0000A8 AF                  A   697    	RET	
                           A   698    .endfunc "i2cWrite",176,"_i2cWrite"
                           A   699    	SEGMENT ROM_DATA
                           A   700    
                           A   701    
                           A   702    ;**************************** _i2cStartRead ***
                           A   703    ;Name                         Addr/Register   S
                           A   704    ;_state                              STATIC    
                           A   705    ;dataLoc                                R11    
                           A   706    ;numToRead                              R10    
                           A   707    ;registerAddress                         R9    
                           A   708    ;deviceAddress                           R8    
                           A   709    
                           A   710    
                           A   711    ; Aggregate Stack Size: 0 (words)
                           A   712    
                           A   713    
                           A   714    	.FRAME _n_i2cStartRead,?_n_i2cStartRead,RDA
                           A   715    	.FRAME _f_i2cStartRead,?_f_i2cStartRead,EDA
                           A   716    	SEGMENT i2c_TEXT
0000A9                     A   717    _i2cStartRead:
                           A   718    .define "_i2cStartRead"
                           A   719    .value _i2cStartRead
                           A   720    .class 2
                           A   721    .type 65
                           A   722    .type 0
                           A   723    .endef
                           A   724    .begfunc "i2cStartRead",188,"_i2cStartRead"
                           A   725    .define "deviceAddress"
                           A   726    .class 17
                           A   727    .reg 9
                           A   728    .type 12
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 20-Oct-16     22:43:47     page:  15


PC     Object              I  Line    Source i2c.src
                           A   729    .type 0
                           A   730    .endef
                           A   731    .define "registerAddress"
                           A   732    .class 17
                           A   733    .reg 10
                           A   734    .type 12
                           A   735    .type 0
                           A   736    .endef
                           A   737    .define "numToRead"
                           A   738    .class 17
                           A   739    .reg 11
                           A   740    .type 12
                           A   741    .type 0
                           A   742    .endef
                           A   743    .define "dataLoc"
                           A   744    .class 17
                           A   745    .reg 12
                           A   746    .type 172
                           A   747    .type 0
                           A   748    .endef
0000A9 D6 0000             A   749    	CALL	__b_frameset00
                           A   750    ;  177	
                           A   751    ;  178	/**************************************
                           A   752    ;  179	Description:
                           A   753    ;  180		Initiates numToRead i2c reads
                           A   754    ;  181	Notes:
                           A   755    ;  182		uses interrupts
                           A   756    ;  183		use i2cIsDataReady() to check when 
                           A   757    ;  184	Returns:
                           A   758    ;  185		none
                           A   759    ;  186	***************************************
                           A   760    ;  187	void i2cStartRead(unsigned char deviceA
                           A   761    ;  188	{
                           A   762    ;  189		//set reading flag
                           A   763    ;  190		state.reading = BUSY;
                           A   764    .line 190
0000AC E9000033            A   765    	LDX	_state,#-0
                           A   766    ;  191		//set internals
                           A   767    ;  192		state.deviceAddress = deviceAddress
                           A   768    .line 192
0000B0 948035              A   769    	LDX	_state+2,R8
                           A   770    ;  193		state.registerAddress = registerAdd
                           A   771    .line 193
0000B3 949036              A   772    	LDX	_state+3,R9
                           A   773    ;  194		state.bytesToRead = numToRead;
                           A   774    .line 194
0000B6 94A037              A   775    	LDX	_state+4,R10
                           A   776    ;  195		state.storePtr = dataLoc;
                           A   777    .line 195
0000B9 94B038              A   778    	LDX	_state+5,R11
0000BC 94C039              A   779    	LDX	_state+6,R12
                           A   780    ;  196		//set state
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 20-Oct-16     22:43:47     page:  16


PC     Object              I  Line    Source i2c.src
                           A   781    ;  197		state.cycle = DEV_ADDESS_WRITE;
                           A   782    .line 197
0000BF E9000034            A   783    	LDX	_state+1,#-0
                           A   784    ;  198		//assert IEN
                           A   785    ;  199		I2CCTL |= I2CEN_MASK;
                           A   786    .line 199
0000C3 49800F52            A   787    	ORX	3922,#128
                           A   788    ;  200		//assert TXI bit
                           A   789    ;  201		I2CCTL |= TXI_MASK;
                           A   790    .line 201
0000C7 49080F52            A   791    	ORX	3922,#8
                           A   792    ;  202	}
                           A   793    .line 202
0000CB D6 0000             A   794    	CALL	__b_framereset
0000CE AF                  A   795    	RET	
                           A   796    .endfunc "i2cStartRead",202,"_i2cStartRead"
                           A   797    	SEGMENT ROM_DATA
                           A   798    
                           A   799    
                           A   800    ;**************************** _mems_read ******
                           A   801    ;Name                         Addr/Register   S
                           A   802    ;_sendString                         IMPORT  --
                           A   803    ;___print_sputch                     IMPORT  --
                           A   804    ;__u_stoa                            IMPORT  --
                           A   805    ;___print_out                        IMPORT    
                           A   806    ;_gyroXValue                         STATIC    
                           A   807    ;_accZValue                          STATIC    
                           A   808    ;_accYValue                          STATIC    
                           A   809    ;_accXValue                          STATIC    
                           A   810    ;_i2cIsDataReady                     IMPORT  --
                           A   811    ;_gyroRead                           STATIC    
                           A   812    ;_accRead                            STATIC    
                           A   813    ;_i2cStartRead                       IMPORT  --
                           A   814    ;_i2cWrite                           IMPORT  --
                           A   815    ;display                             R15-25    
                           A   816    
                           A   817    
                           A   818    ; Aggregate Stack Size: -25 (words)
                           A   819    
                           A   820    
                           A   821    	.FRAME _n_mems_read,?_n_mems_read,RDATA
                           A   822    	.FCALL _n_i2cWrite
                           A   823    	.FCALL _n_i2cStartRead
                           A   824    	.FCALL _n_i2cIsDataReady
                           A   825    	.FCALL _n__u_stoa
                           A   826    	.FCALL _n___print_sputch
                           A   827    	.FCALL _n_sendString
                           A   828    	.FRAME _f_mems_read,?_f_mems_read,EDATA
                           A   829    	.FCALL _f_i2cWrite
                           A   830    	.FCALL _f_i2cStartRead
                           A   831    	.FCALL _f_i2cIsDataReady
                           A   832    	.FCALL _f__u_stoa
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 20-Oct-16     22:43:47     page:  17


PC     Object              I  Line    Source i2c.src
                           A   833    	.FCALL _f___print_sputch
                           A   834    	.FCALL _f_sendString
                           A   835    	SEGMENT TEXT
000000                     A   836    L__14:
000000 0D0A00              A   837    	DB	13,10,0
                           A   838    	SEGMENT i2c_TEXT
0000CF                     A   839    _mems_read:
                           A   840    .define "_mems_read"
                           A   841    .value _mems_read
                           A   842    .class 2
                           A   843    .type 65
                           A   844    .type 0
                           A   845    .endef
                           A   846    .begfunc "mems_read",204,"_mems_read"
                           A   847    ;  203	
                           A   848    ;  204	void mems_read(void){
                           A   849    .define "display"
                           A   850    .class 1
                           A   851    .value -25
                           A   852    .dim 25
                           A   853    .type 98
                           A   854    .type 0
                           A   855    .endef
0000CF 5C19                A   856    	LD	R5,#25
0000D1 D6 0000             A   857    	CALL	__b_frameset0
                           A   858    ;  205		char display[25];
                           A   859    ;  206		i2cWrite(ACCEL, REG1_A_ADDRESS, REG
                           A   860    .line 206
0000D4 AC97                A   861    	LD	R10,#151
0000D6 9C20                A   862    	LD	R9,#32
0000D8 8C30                A   863    	LD	R8,#48
0000DA D6 005B             A   864    	CALL	_i2cWrite
                           A   865    ;  207		i2cWrite(ACCEL, REG4_A_ADDRESS, REG
                           A   866    .line 207
0000DD AC48                A   867    	LD	R10,#72
0000DF 9C23                A   868    	LD	R9,#35
0000E1 8C30                A   869    	LD	R8,#48
0000E3 D6 005B             A   870    	CALL	_i2cWrite
                           A   871    ;  208		i2cWrite(GYRO, REG1_G_ADDRESS, REG1
                           A   872    .line 208
0000E6 ACFF                A   873    	LD	R10,#255
0000E8 9C20                A   874    	LD	R9,#32
0000EA 8CD4                A   875    	LD	R8,#212
0000EC D6 005B             A   876    	CALL	_i2cWrite
                           A   877    ;  209		i2cWrite(GYRO, REG4_G_ADDRESS, REG4
                           A   878    .line 209
0000EF AC40                A   879    	LD	R10,#64
0000F1 9C23                A   880    	LD	R9,#35
0000F3 8CD4                A   881    	LD	R8,#212
0000F5 D6 005B             A   882    	CALL	_i2cWrite
                           A   883    ;  210		i2cWrite(GYRO, REG5_G_ADDRESS, REG5
                           A   884    .line 210
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 20-Oct-16     22:43:47     page:  18


PC     Object              I  Line    Source i2c.src
0000F8 AC10                A   885    	LD	R10,#16
0000FA 9C24                A   886    	LD	R9,#36
0000FC 8CD4                A   887    	LD	R8,#212
0000FE D6 005B             A   888    	CALL	_i2cWrite
                           A   889    ;  211	
                           A   890    ;  212		i2cStartRead(ACCEL, X_LOW_ADDRESS, 
                           A   891    .line 212
000101 BC 00               A   892    	LD	R11,#high(_accRead)
000103 CC 1B               A   893    	LD	R12,#low(_accRead)
000105 AC06                A   894    	LD	R10,#6
000107 9C28                A   895    	LD	R9,#40
000109 8C30                A   896    	LD	R8,#48
00010B D6 00A9             A   897    	CALL	_i2cStartRead
                           A   898    ;  213		i2cStartRead(GYRO, RATE_LOW_ADDRESS
                           A   899    .line 213
00010E BC 00               A   900    	LD	R11,#high(_gyroRead)
000110 CC 19               A   901    	LD	R12,#low(_gyroRead)
000112 AC02                A   902    	LD	R10,#2
000114 9C28                A   903    	LD	R9,#40
000116 8CD4                A   904    	LD	R8,#212
000118 D6 00A9             A   905    	CALL	_i2cStartRead
                           A   906    ;  214		// i2cStartRead(ACCEL, X_HIGH_ADDRE
                           A   907    ;  215	
                           A   908    ;  216		// i2cStartRead(ACCEL, Y_LOW_ADDRES
                           A   909    ;  217		// i2cStartRead(ACCEL, Y_HIGH_ADDRE
                           A   910    ;  218		//
                           A   911    ;  219		// i2cStartRead(GYRO, RATE_LOW_ADDR
                           A   912    ;  220		// i2cStartRead(GYRO, RATE_HIGH_ADD
                           A   913    ;  221	
                           A   914    ;  222		// acc_xh = *acc_data_xh;
                           A   915    ;  223		// acc_xl = *acc_data_xl;
                           A   916    ;  224		// acc_x = (acc_xl & ((acc_xh<<8) &
                           A   917    ;  225		//
                           A   918    ;  226		// acc_yh = *acc_data_yh;
                           A   919    ;  227		// acc_yl = *acc_data_yl;
                           A   920    ;  228		// acc_y = (acc_yl & ((acc_yh<<8) &
                           A   921    ;  229	
                           A   922    ;  230	
                           A   923    ;  231		// gyro_h = *gyro_data_h;
                           A   924    ;  232		// gyro_l = *gyro_data_l;
                           A   925    ;  233		// gyro_val = (((gyro_h << 8) & 0xF
                           A   926    ;  234		while(i2cIsDataReady()==0){}
00011B                     A   927    _4_L_20:
                           A   928    .line 234
00011B D6 0295             A   929    	CALL	_i2cIsDataReady
00011E 4200                A   930    	OR	R0,R0
000120 6B F9               A   931    	JR	Z,_4_L_20
                           A   932    ;  235		accXValue = accRead[1] & ((accRead[
                           A   933    .line 235
000122 84101C              A   934    	LDX	R1,_accRead+1
000125 E4E1E0              A   935    	LD	R0,R1
000128 90E0                A   936    	RL	R0
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 20-Oct-16     22:43:47     page:  19


PC     Object              I  Line    Source i2c.src
00012A 3200                A   937    	SBC	R0,R0
00012C E8 01B02B           A   938    	LDX	_accXValue,_accRead
000130 E900002C            A   939    	LDX	_accXValue+1,#-0
000134 58EE102C            A   940    	ANDX	_accXValue+1,R1
000138 58EE002B            A   941    	ANDX	_accXValue,R0
                           A   942    ;  236		accYValue = accRead[3] & ((accRead[
                           A   943    .line 236
00013C 84101E              A   944    	LDX	R1,_accRead+3
00013F E4E1E0              A   945    	LD	R0,R1
000142 90E0                A   946    	RL	R0
000144 3200                A   947    	SBC	R0,R0
000146 E8 01D02D           A   948    	LDX	_accYValue,_accRead+2
00014A E900002E            A   949    	LDX	_accYValue+1,#-0
00014E 58EE102E            A   950    	ANDX	_accYValue+1,R1
000152 58EE002D            A   951    	ANDX	_accYValue,R0
                           A   952    ;  237		accZValue = accRead[5] & ((accRead[
                           A   953    .line 237
000156 841020              A   954    	LDX	R1,_accRead+5
000159 E4E1E0              A   955    	LD	R0,R1
00015C 90E0                A   956    	RL	R0
00015E 3200                A   957    	SBC	R0,R0
000160 E8 01F02F           A   958    	LDX	_accZValue,_accRead+4
000164 E9000030            A   959    	LDX	_accZValue+1,#-0
000168 58EE1030            A   960    	ANDX	_accZValue+1,R1
00016C 58EE002F            A   961    	ANDX	_accZValue,R0
                           A   962    ;  238		gyroXValue = gyroRead[0] & ((gyroRe
                           A   963    .line 238
000170 841019              A   964    	LDX	R1,_gyroRead
000173 E4E1E0              A   965    	LD	R0,R1
000176 90E0                A   966    	RL	R0
000178 3200                A   967    	SBC	R0,R0
00017A E8 01A031           A   968    	LDX	_gyroXValue,_gyroRead+1
00017E E9000032            A   969    	LDX	_gyroXValue+1,#-0
000182 58EE1032            A   970    	ANDX	_gyroXValue+1,R1
000186 58EE0031            A   971    	ANDX	_gyroXValue,R0
                           A   972    ;  239	// 	gyroYValue = gyroRead[2] & ((gyroRe
                           A   973    ;  240	// 	gyroZValue = gyroRead[4] & ((gyroRe
                           A   974    ;  241	
                           A   975    ;  242		//LCD Display
                           A   976    ;  243	// 	if(accXValue != 0){
                           A   977    ;  244	
                           A   978    ;  245			sprintf(display, "%d", accXValu
                           A   979    .line 245
00018A 1CFF                A   980    	LD	R1,#255
00018C 0CE7                A   981    	LD	R0,#231
00018E 020F                A   982    	ADD	R0,R15
000190 121E                A   983    	ADC	R1,R14
000192 941000              A   984    	LDX	___print_out,R1
000195 940001              A   985    	LDX	___print_out+1,R0
000198 84802B              A   986    	LDX	R8,_accXValue
00019B 84902C              A   987    	LDX	R9,_accXValue+1
00019E D6 0000             A   988    	CALL	__u_stoa
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 20-Oct-16     22:43:47     page:  20


PC     Object              I  Line    Source i2c.src
0001A1 B0E8                A   989    	CLR	R8
0001A3 D6 0000             A   990    	CALL	___print_sputch
                           A   991    ;  246			sendString(display);
                           A   992    .line 246
0001A6 998EE7              A   993    	LEA	RR8,231(RR14)
0001A9 D6 0000             A   994    	CALL	_sendString
                           A   995    ;  247			sendString("\r\n");
                           A   996    .line 247
0001AC 8C 00               A   997    	LD	R8,#high(L__14)
0001AE 9C 00               A   998    	LD	R9,#low(L__14)
0001B0 D6 0000             A   999    	CALL	_sendString
                           A  1000    ;  248	// 	}
                           A  1001    ;  249	}
                           A  1002    .line 249
0001B3 D6 0000             A  1003    	CALL	__b_framereset
0001B6 AF                  A  1004    	RET	
                           A  1005    .endfunc "mems_read",249,"_mems_read"
                           A  1006    	SEGMENT ROM_DATA
                           A  1007    ;	Jump Table for Switch Statement at line 297
000000                     A  1008    L__20:
000000 0004                A  1009    	DW	4
000002 0000                A  1010    	DW	0
000004 0219                A  1011    	DW	_5_L_26
000006 0001                A  1012    	DW	1
000008 022B                A  1013    	DW	_5_L_27
00000A 0002                A  1014    	DW	2
00000C 0245                A  1015    	DW	_5_L_31
00000E 0004                A  1016    	DW	4
000010 026B                A  1017    	DW	_5_L_35
000012 0291                A  1018    	DW	_5_L_44
                           A  1019    
                           A  1020    
                           A  1021    ;**************************** _Si2c_Isr *******
                           A  1022    ;Name                         Addr/Register   S
                           A  1023    ;_state                              STATIC    
                           A  1024    
                           A  1025    
                           A  1026    ; Aggregate Stack Size: 0 (words)
                           A  1027    
                           A  1028    
                           A  1029    	.FRAME _n_Si2c_Isr,?_n_Si2c_Isr,RDATA
                           A  1030    	.FRAME _f_Si2c_Isr,?_f_Si2c_Isr,EDATA
                           A  1031    	SEGMENT i2c_TEXT
0001B7                     A  1032    _Si2c_Isr:
                           A  1033    .define "_Si2c_Isr"
                           A  1034    .value _Si2c_Isr
                           A  1035    .class 2
                           A  1036    .type 65
                           A  1037    .type 0
                           A  1038    .endef
                           A  1039    .begfunc "Si2c_Isr",262,"_Si2c_Isr"
0001B7 C8FFD0              A  1040    	PUSHX	4093
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 20-Oct-16     22:43:47     page:  21


PC     Object              I  Line    Source i2c.src
0001BA D6 0000             A  1041    	CALL	__b_iframeset00
                           A  1042    ;  250	
                           A  1043    ;  251	
                           A  1044    ;  252	
                           A  1045    ;  253	/**************************************
                           A  1046    ;  254	Description: State machine handles
                           A  1047    ;  255			Nack interrupt
                           A  1048    ;  256			Empty Interrupt
                           A  1049    ;  257			Recieve interrupt
                           A  1050    ;  258	
                           A  1051    ;  259	***************************************
                           A  1052    ;  260	#pragma interrupt
                           A  1053    ;  261	void Si2c_Isr(void)
                           A  1054    ;  262	{
                           A  1055    ;  263		//Disable Interrupts
                           A  1056    ;  264		if(I2CSTAT & NCKI_MASK) //not ack i
                           A  1057    .line 264
0001BD 79010F51            A  1058    	TMX	3921,#1
0001C1 6B 3C               A  1059    	JR	Z,_5_L_43
                           A  1060    ;  265		{
                           A  1061    ;  266			//in read last byte statwe
                           A  1062    ;  267			if(state.cycle == READ_LAST)
                           A  1063    .line 267
0001C3 A9050034            A  1064    	CPX	_state+1,#5
0001C7 EB 1F               A  1065    	JR	NE,_5_L_25
                           A  1066    ;  268			{
                           A  1067    ;  269				//read i2c data
                           A  1068    ;  270				*(state.storePtr) = I2CDATA
                           A  1069    .line 270
0001C9 840038              A  1070    	LDX	R0,_state+5
0001CC 841039              A  1071    	LDX	R1,_state+6
0001CF 842F50              A  1072    	LDX	R2,3920
0001D2 96E2E0              A  1073    	LDX	@RR0,R2
                           A  1074    ;  271				//assert stop
                           A  1075    ;  272				I2CCTL |= STOP_MASK;
                           A  1076    .line 272
0001D5 49200F52            A  1077    	ORX	3922,#32
                           A  1078    ;  273				//read cycle completed
                           A  1079    ;  274				state.cycle = END_CYCLE;
                           A  1080    .line 274
0001D9 E9060034            A  1081    	LDX	_state+1,#6
                           A  1082    ;  275				//clear reading ass samples
                           A  1083    ;  276				state.reading  = DONE;
                           A  1084    .line 276
0001DD E9010033            A  1085    	LDX	_state,#1
                           A  1086    ;  277				//disable i2c
                           A  1087    ;  278				I2CCTL &= ~I2CEN_MASK;
                           A  1088    .line 278
0001E1 597F0F52            A  1089    	ANDX	3922,#127
                           A  1090    ;  279			}
                           A  1091    ;  280			else
                           A  1092    .line 280
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 20-Oct-16     22:43:47     page:  22


PC     Object              I  Line    Source i2c.src
0001E5 8D 02 91            A  1093    	JR	_5_L_44
0001E8                     A  1094    _5_L_25:
                           A  1095    ;  281			{
                           A  1096    ;  282				//error
                           A  1097    ;  283				//set stop and flush bits
                           A  1098    ;  284				I2CCTL |= (STOP_MASK | FLUS
                           A  1099    .line 284
0001E8 49220F52            A  1100    	ORX	3922,#34
                           A  1101    ;  285				//clear txi
                           A  1102    ;  286				I2CCTL &= ~TXI_MASK;
                           A  1103    .line 286
0001EC 59F70F52            A  1104    	ANDX	3922,#-9
                           A  1105    ;  287				//reset state
                           A  1106    ;  288				state.cycle = END_CYCLE;
                           A  1107    .line 288
0001F0 E9060034            A  1108    	LDX	_state+1,#6
                           A  1109    ;  289				//report failure
                           A  1110    ;  290				state.reading  = FAILED;
                           A  1111    .line 290
0001F4 E9FF0033            A  1112    	LDX	_state,#-1
                           A  1113    ;  291				//disable i2c
                           A  1114    ;  292				I2CCTL &= ~I2CEN_MASK;
                           A  1115    .line 292
0001F8 597F0F52            A  1116    	ANDX	3922,#127
                           A  1117    ;  293			}
                           A  1118    ;  294		}
                           A  1119    ;  295		else if(I2CSTAT & (TDRE_MASK| RDRF_
                           A  1120    .line 295
0001FC 8D 02 91            A  1121    	JR	_5_L_44
0001FF                     A  1122    _5_L_43:
0001FF 79C00F51            A  1123    	TMX	3921,#192
000203 6D 02 91            A  1124    	JR	Z,_5_L_44
                           A  1125    ;  296		{
                           A  1126    ;  297			switch (state.cycle)
                           A  1127    .line 297
000206 841034              A  1128    	LDX	R1,_state+1
000209 E4E1E0              A  1129    	LD	R0,R1
00020C 90E0                A  1130    	RL	R0
00020E 3200                A  1131    	SBC	R0,R0
000210 2C 00               A  1132    	LD	R2,#high(L__20)
000212 3C 00               A  1133    	LD	R3,#low(L__20)
000214 D6 0000             A  1134    	CALL	__b_ucase
000217 C4E0                A  1135    	JP	@RR0
                           A  1136    ;  298			{
                           A  1137    ;  299				case DEV_ADDESS_WRITE:
000219                     A  1138    _5_L_26:
                           A  1139    .line 299
                           A  1140    ;  300					//write device address 
                           A  1141    ;  301					I2CDATA = state.deviceA
                           A  1142    .line 301
000219 840035              A  1143    	LDX	R0,_state+2
00021C E200                A  1144    	BCLR	0,R0
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 20-Oct-16     22:43:47     page:  23


PC     Object              I  Line    Source i2c.src
00021E 940F50              A  1145    	LDX	3920,R0
                           A  1146    ;  302					//assert start
                           A  1147    ;  303					I2CCTL |= START_MASK;
                           A  1148    .line 303
000221 49400F52            A  1149    	ORX	3922,#64
                           A  1150    ;  304					//set to next state
                           A  1151    ;  305					state.cycle = DEV_SUB_A
                           A  1152    .line 305
000225 E9010034            A  1153    	LDX	_state+1,#1
                           A  1154    ;  306					break;
                           A  1155    .line 306
000229 8B 66               A  1156    	JR	_5_L_44
                           A  1157    ;  307				case DEV_SUB_ADDRESS:
00022B                     A  1158    _5_L_27:
                           A  1159    .line 307
                           A  1160    ;  308					if(state.bytesToRead > 
                           A  1161    .line 308
00022B A9010037            A  1162    	CPX	_state+4,#1
00022F 3B 0A               A  1163    	JR	ULE,_5_L_29
                           A  1164    ;  309					{
                           A  1165    ;  310						//set first bit to 
                           A  1166    ;  311						I2CDATA = AUTO_INC 
                           A  1167    .line 311
000231 840036              A  1168    	LDX	R0,_state+3
000234 E2F0                A  1169    	BSET	7,R0
000236 940F50              A  1170    	LDX	3920,R0
                           A  1171    ;  312					}
                           A  1172    ;  313					else
                           A  1173    .line 313
000239 8B 04               A  1174    	JR	_5_L_30
00023B                     A  1175    _5_L_29:
                           A  1176    ;  314					{
                           A  1177    ;  315						//write device sub 
                           A  1178    ;  316						I2CDATA = state.reg
                           A  1179    .line 316
00023B E8 036F50           A  1180    	LDX	3920,_state+3
                           A  1181    ;  317					}
00023F                     A  1182    _5_L_30:
                           A  1183    .line 317
                           A  1184    ;  318					//need to wait till i2c
                           A  1185    ;  319					//set to next state
                           A  1186    ;  320					state.cycle = START_REA
                           A  1187    .line 320
00023F E9020034            A  1188    	LDX	_state+1,#2
                           A  1189    ;  321					break;
                           A  1190    .line 321
000243 8B 4C               A  1191    	JR	_5_L_44
                           A  1192    ;  322				case START_READ:
000245                     A  1193    _5_L_31:
                           A  1194    .line 322
                           A  1195    ;  323					//commence read cycle
                           A  1196    ;  324					//write device address 
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 20-Oct-16     22:43:47     page:  24


PC     Object              I  Line    Source i2c.src
                           A  1197    ;  325					I2CDATA = state.deviceA
                           A  1198    .line 325
000245 840035              A  1199    	LDX	R0,_state+2
000248 E280                A  1200    	BSET	0,R0
00024A 940F50              A  1201    	LDX	3920,R0
                           A  1202    ;  326					//assert start
                           A  1203    ;  327					I2CCTL |= START_MASK;
                           A  1204    .line 327
00024D 49400F52            A  1205    	ORX	3922,#64
                           A  1206    ;  328					//clear TXI (stops tran
                           A  1207    ;  329					I2CCTL &= ~TXI_MASK;
                           A  1208    .line 329
000251 59F70F52            A  1209    	ANDX	3922,#-9
                           A  1210    ;  330					if(state.bytesToRead ==
                           A  1211    .line 330
000255 A9010037            A  1212    	CPX	_state+4,#1
000259 EB 0A               A  1213    	JR	NE,_5_L_33
                           A  1214    ;  331					{
                           A  1215    ;  332						//set state to read
                           A  1216    ;  333						state.cycle = READ_
                           A  1217    .line 333
00025B E9050034            A  1218    	LDX	_state+1,#5
                           A  1219    ;  334						//set NACK bit will
                           A  1220    ;  335						I2CCTL |= NAK_MASK;
                           A  1221    .line 335
00025F 49040F52            A  1222    	ORX	3922,#4
                           A  1223    ;  336					}
                           A  1224    ;  337					else
                           A  1225    .line 337
000263 8B 2C               A  1226    	JR	_5_L_44
000265                     A  1227    _5_L_33:
                           A  1228    ;  338					{
                           A  1229    ;  339						//set state to read
                           A  1230    ;  340						state.cycle = READ_
                           A  1231    .line 340
000265 E9040034            A  1232    	LDX	_state+1,#4
                           A  1233    ;  341					}
                           A  1234    .line 341
                           A  1235    ;  342	
                           A  1236    ;  343					break;
                           A  1237    .line 343
000269 8B 26               A  1238    	JR	_5_L_44
                           A  1239    ;  344				case READ_BYTE:
00026B                     A  1240    _5_L_35:
                           A  1241    .line 344
                           A  1242    ;  345					//read i2c data
                           A  1243    ;  346					*(state.storePtr) = I2C
                           A  1244    .line 346
00026B 840038              A  1245    	LDX	R0,_state+5
00026E 841039              A  1246    	LDX	R1,_state+6
000271 842F50              A  1247    	LDX	R2,3920
000274 96E2E0              A  1248    	LDX	@RR0,R2
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 20-Oct-16     22:43:47     page:  25


PC     Object              I  Line    Source i2c.src
                           A  1249    ;  347					//move next location
                           A  1250    ;  348					state.storePtr++;
                           A  1251    .line 348
000277 09010039            A  1252    	ADDX	_state+6,#1
00027B 19000038            A  1253    	ADCX	_state+5,#-0
                           A  1254    ;  349					state.bytesToRead--;
                           A  1255    .line 349
00027F 29010037            A  1256    	SUBX	_state+4,#1
                           A  1257    ;  350					if(state.bytesToRead ==
                           A  1258    .line 350
000283 A9010037            A  1259    	CPX	_state+4,#1
000287 EB 08               A  1260    	JR	NE,_5_L_39
                           A  1261    ;  351					{
                           A  1262    ;  352						//set NACK bit will
                           A  1263    ;  353						I2CCTL |= NAK_MASK;
                           A  1264    .line 353
000289 49040F52            A  1265    	ORX	3922,#4
                           A  1266    ;  354						//set state to last
                           A  1267    ;  355						state.cycle = READ_
                           A  1268    .line 355
00028D E9050034            A  1269    	LDX	_state+1,#5
                           A  1270    ;  356					}
000291                     A  1271    _5_L_39:
                           A  1272    .line 356
                           A  1273    ;  357					break;
                           A  1274    ;  358				default:
                           A  1275    ;  359					//should not happen
                           A  1276    ;  360					break;
                           A  1277    ;  361			}
                           A  1278    ;  362		}
                           A  1279    ;  363	}
000291                     A  1280    _5_L_44:
                           A  1281    .line 363
000291 D6 0000             A  1282    	CALL	__b_iframereset
000294 BF                  A  1283    	IRET	
                           A  1284    .endfunc "Si2c_Isr",363,"_Si2c_Isr"
                           A  1285    	SEGMENT ROM_DATA
                           A  1286    
                           A  1287    
                           A  1288    ;**************************** _i2cIsDataReady *
                           A  1289    ;Name                         Addr/Register   S
                           A  1290    ;_state                              STATIC    
                           A  1291    
                           A  1292    
                           A  1293    ; Aggregate Stack Size: 0 (words)
                           A  1294    
                           A  1295    
                           A  1296    	.FRAME _n_i2cIsDataReady,?_n_i2cIsDataReady
                           A  1297    	.FRAME _f_i2cIsDataReady,?_f_i2cIsDataReady
                           A  1298    	SEGMENT i2c_TEXT
000295                     A  1299    _i2cIsDataReady:
                           A  1300    .define "_i2cIsDataReady"
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 20-Oct-16     22:43:47     page:  26


PC     Object              I  Line    Source i2c.src
                           A  1301    .value _i2cIsDataReady
                           A  1302    .class 2
                           A  1303    .type 66
                           A  1304    .type 0
                           A  1305    .endef
                           A  1306    .begfunc "i2cIsDataReady",375,"_i2cIsDataReady"
000295 D6 0000             A  1307    	CALL	__b_frameset00
                           A  1308    ;  364	
                           A  1309    ;  365	/**************************************
                           A  1310    ;  366	Description:
                           A  1311    ;  367		gives the state of a i2c read
                           A  1312    ;  368	Notes:
                           A  1313    ;  369		is not valid until a i2cStartRead h
                           A  1314    ;  370	Returns:
                           A  1315    ;  371		read;
                           A  1316    ;  372		1 <= done, 0 <= busy , -1 <= failed
                           A  1317    ;  373	***************************************
                           A  1318    ;  374	char i2cIsDataReady(void)
                           A  1319    ;  375	{
                           A  1320    ;  376		return (char) state.reading;
                           A  1321    .line 376
000298 840033              A  1322    	LDX	R0,_state
                           A  1323    ;  377	}
                           A  1324    .line 377
00029B D6 0000             A  1325    	CALL	__b_framereset
00029E AF                  A  1326    	RET	
                           A  1327    .endfunc "i2cIsDataReady",377,"_i2cIsDataReady"
                           A  1328    	SEGMENT ROM_DATA
                           A  1329    
                           A  1330    
                           A  1331    ;**************************** _t1_mem_isr *****
                           A  1332    ;Name                         Addr/Register   S
                           A  1333    ;_sendString                         IMPORT  --
                           A  1334    ;___print_sputch                     IMPORT  --
                           A  1335    ;__u_stoa                            IMPORT  --
                           A  1336    ;___print_out                        IMPORT    
                           A  1337    ;_accXValue                          STATIC    
                           A  1338    ;_mems_read                          IMPORT  --
                           A  1339    ;display                             R15-25    
                           A  1340    
                           A  1341    
                           A  1342    ; Aggregate Stack Size: -25 (words)
                           A  1343    
                           A  1344    
                           A  1345    	.FRAME _n_t1_mem_isr,?_n_t1_mem_isr,RDATA
                           A  1346    	.FCALL _n_mems_read
                           A  1347    	.FCALL _n__u_stoa
                           A  1348    	.FCALL _n___print_sputch
                           A  1349    	.FCALL _n_sendString
                           A  1350    	.FRAME _f_t1_mem_isr,?_f_t1_mem_isr,EDATA
                           A  1351    	.FCALL _f_mems_read
                           A  1352    	.FCALL _f__u_stoa
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 20-Oct-16     22:43:47     page:  27


PC     Object              I  Line    Source i2c.src
                           A  1353    	.FCALL _f___print_sputch
                           A  1354    	.FCALL _f_sendString
                           A  1355    	SEGMENT TEXT
000003                     A  1356    L__29:
000003 0D0A00              A  1357    	DB	13,10,0
                           A  1358    	SEGMENT i2c_TEXT
00029F                     A  1359    _t1_mem_isr:
                           A  1360    .define "_t1_mem_isr"
                           A  1361    .value _t1_mem_isr
                           A  1362    .class 2
                           A  1363    .type 65
                           A  1364    .type 0
                           A  1365    .endef
                           A  1366    .begfunc "t1_mem_isr",380,"_t1_mem_isr"
                           A  1367    ;  378	
                           A  1368    ;  379	#pragma interrupt
                           A  1369    ;  380	void t1_mem_isr(void){
                           A  1370    .define "display"
                           A  1371    .class 1
                           A  1372    .value -25
                           A  1373    .dim 25
                           A  1374    .type 98
                           A  1375    .type 0
                           A  1376    .endef
00029F C8FFD0              A  1377    	PUSHX	4093
0002A2 E8 000FFD           A  1378    	LDX	4093,__intrp
0002A6 09100000            A  1379    	ADDX	__intrp,#16
0002AA 5C19                A  1380    	LD	R5,#25
0002AC D6 0000             A  1381    	CALL	__b_frameset0
                           A  1382    ;  381		char display[25];
                           A  1383    ;  382	
                           A  1384    ;  383		mems_read();
                           A  1385    .line 383
0002AF D6 00CF             A  1386    	CALL	_mems_read
                           A  1387    ;  384		if(accXValue != 0){
                           A  1388    .line 384
0002B2 84002B              A  1389    	LDX	R0,_accXValue
0002B5 48 02CEE0           A  1390    	ORX	R0,_accXValue+1
0002B9 6B 29               A  1391    	JR	Z,_7_L_47
                           A  1392    ;  385	
                           A  1393    ;  386			sprintf(display, "%d", accXValu
                           A  1394    .line 386
0002BB 1CFF                A  1395    	LD	R1,#255
0002BD 0CE7                A  1396    	LD	R0,#231
0002BF 020F                A  1397    	ADD	R0,R15
0002C1 121E                A  1398    	ADC	R1,R14
0002C3 941000              A  1399    	LDX	___print_out,R1
0002C6 940001              A  1400    	LDX	___print_out+1,R0
0002C9 84802B              A  1401    	LDX	R8,_accXValue
0002CC 84902C              A  1402    	LDX	R9,_accXValue+1
0002CF D6 0000             A  1403    	CALL	__u_stoa
0002D2 B0E8                A  1404    	CLR	R8
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 20-Oct-16     22:43:47     page:  28


PC     Object              I  Line    Source i2c.src
0002D4 D6 0000             A  1405    	CALL	___print_sputch
                           A  1406    ;  387			sendString(display);
                           A  1407    .line 387
0002D7 998EE7              A  1408    	LEA	RR8,231(RR14)
0002DA D6 0000             A  1409    	CALL	_sendString
                           A  1410    ;  388			sendString("\r\n");
                           A  1411    .line 388
0002DD 8C 00               A  1412    	LD	R8,#high(L__29)
0002DF 9C 03               A  1413    	LD	R9,#low(L__29)
0002E1 D6 0000             A  1414    	CALL	_sendString
                           A  1415    ;  389		}
                           A  1416    ;  390	// 	printMessage(display, 1);
                           A  1417    ;  391	}
0002E4                     A  1418    _7_L_47:
                           A  1419    .line 391
0002E4 D6 0000             A  1420    	CALL	__b_iframereset
0002E7 BF                  A  1421    	IRET	
                           A  1422    .endfunc "t1_mem_isr",391,"_t1_mem_isr"
00000A 029F                A  1423    	VECTOR	TIMER1=_t1_mem_isr
000012 01B7                A  1424    	VECTOR	I2C=_Si2c_Isr
                           A  1425    	XREF _sendString:ROM
                           A  1426    	XREF __u_stoa:ROM
                           A  1427    	XREF ___print_sputch:ROM
                           A  1428    	XREF ___print_out:EDATA
                           A  1429    	XREF __b_ucase:ROM
                           A  1430    	XREF __b_framereset:ROM
                           A  1431    	XREF __b_iframereset:ROM
                           A  1432    	XREF __b_frameset0:ROM
                           A  1433    	XREF __b_frameset00:ROM
                           A  1434    	XREF __b_iframeset00:ROM
                           A  1435    	XREF __intrp:EDATA
                           A  1436    	XDEF _t1_mem_isr
                           A  1437    	XDEF _i2cIsDataReady
                           A  1438    	XDEF _Si2c_Isr
                           A  1439    	XDEF _mems_read
                           A  1440    	XDEF _i2cStartRead
                           A  1441    	XDEF _i2cWrite
                           A  1442    	XDEF _i2cInit
                           A  1443    	XDEF _gyroXValue
                           A  1444    	XDEF _accZValue
                           A  1445    	XDEF _accYValue
                           A  1446    	XDEF _accXValue
                           A  1447    	XDEF _gyro_val
                           A  1448    	XDEF _gyro_l
                           A  1449    	XDEF _gyro_h
                           A  1450    	XDEF _acc_x
                           A  1451    	XDEF _acc_y
                           A  1452    	XDEF _acc_yl
                           A  1453    	XDEF _acc_yh
                           A  1454    	XDEF _acc_xl
                           A  1455    	XDEF _acc_xh
                           A  1456    	XDEF _accRead
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 20-Oct-16     22:43:47     page:  29


PC     Object              I  Line    Source i2c.src
                           A  1457    	XDEF _gyroRead
                           A  1458    	XDEF _rxFlag
                           A  1459    	XDEF _command
                           A  1460    	XDEF _txFinished
                           A  1461    	XDEF _string
                           A  1462    	XDEF _inChar
                           A  1463    	END


Errors: 0
Warnings: 0
Lines Assembled: 1464
