Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:   1


PC     Object              I  Line    Source 
                           A     1    ; Zilog Z8 Encore! ANSI C Compiler Release 3.62
                           A     2    ; -nolocalcse -optsize -nofastcall -const=RAM -
                           A     3    ; -nooptlink -regvar -reduceopt -debug -norevaa
                           A     4    ; -alias 
                           A     5    	DEFINE i2c_TEXT,SPACE=ROM
                           A     6    	FILE	"..\..\..\..\DOCUME~1\GITHUB\THIRDY
                           A     7    .debug "C"
                           A     8    	SEGMENT FAR_DATA
000000                     A     9    _inChar:
000000 00                  A    10    	DB	0
                           A    11    .define "inChar"
                           A    12    .alias "_inChar"
                           A    13    .class 69
                           A    14    .value _inChar
                           A    15    .type 2
                           A    16    .type 0
                           A    17    .endef
                           A    18    	SEGMENT i2c_TEXT
                           A    19    .begrec "fmt_type",16
                           A    20    .define "status"
                           A    21    .value 0
                           A    22    .class 8
                           A    23    .type 12
                           A    24    .type 0
                           A    25    .endef
                           A    26    .define "flags"
                           A    27    .value 1
                           A    28    .class 8
                           A    29    .type 12
                           A    30    .type 0
                           A    31    .endef
                           A    32    .define "size"
                           A    33    .value 2
                           A    34    .class 8
                           A    35    .type 2
                           A    36    .type 0
                           A    37    .endef
                           A    38    .define "chr"
                           A    39    .value 3
                           A    40    .class 8
                           A    41    .type 2
                           A    42    .type 0
                           A    43    .endef
                           A    44    .define "type"
                           A    45    .value 4
                           A    46    .class 8
                           A    47    .type 2
                           A    48    .type 0
                           A    49    .endef
                           A    50    .define "field_width"
                           A    51    .value 5
                           A    52    .class 8
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:   2


PC     Object              I  Line    Source i2c.src
                           A    53    .type 2
                           A    54    .type 0
                           A    55    .endef
                           A    56    .define "precision"
                           A    57    .value 6
                           A    58    .class 8
                           A    59    .type 2
                           A    60    .type 0
                           A    61    .endef
                           A    62    .define "set_begin"
                           A    63    .value 7
                           A    64    .class 8
                           A    65    .type 162
                           A    66    .type 0
                           A    67    .endef
                           A    68    .define "set_end"
                           A    69    .value 9
                           A    70    .class 8
                           A    71    .type 162
                           A    72    .type 0
                           A    73    .endef
                           A    74    .define "pad_whole"
                           A    75    .value 11
                           A    76    .class 8
                           A    77    .type 12
                           A    78    .type 0
                           A    79    .endef
                           A    80    .define "pad_pre_fract"
                           A    81    .value 12
                           A    82    .class 8
                           A    83    .type 12
                           A    84    .type 0
                           A    85    .endef
                           A    86    .define "pad_post_fract"
                           A    87    .value 13
                           A    88    .class 8
                           A    89    .type 12
                           A    90    .type 0
                           A    91    .endef
                           A    92    .define "pad_at"
                           A    93    .value 14
                           A    94    .class 8
                           A    95    .type 162
                           A    96    .type 0
                           A    97    .endef
                           A    98    .endrec "fmt_type"
                           A    99    .begrec "flt_info",12
                           A   100    .define "flags"
                           A   101    .value 0
                           A   102    .class 8
                           A   103    .type 12
                           A   104    .type 0
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:   3


PC     Object              I  Line    Source i2c.src
                           A   105    .endef
                           A   106    .define "exp"
                           A   107    .value 1
                           A   108    .class 8
                           A   109    .type 2
                           A   110    .type 0
                           A   111    .endef
                           A   112    .define "digits"
                           A   113    .value 2
                           A   114    .class 8
                           A   115    .dim 10
                           A   116    .type 108
                           A   117    .type 0
                           A   118    .endef
                           A   119    .endrec "flt_info"
                           A   120    	SEGMENT FAR_BSS
000000                     A   121    _string:
000000                     A   122    	DS	25
                           A   123    .define "string"
                           A   124    .alias "_string"
                           A   125    .class 83
                           A   126    .value _string
                           A   127    .dim 25
                           A   128    .type 98
                           A   129    .type 0
                           A   130    .endef
                           A   131    	SEGMENT FAR_DATA
000001                     A   132    _txFinished:
000001 01                  A   133    	DB	1
                           A   134    .define "txFinished"
                           A   135    .alias "_txFinished"
                           A   136    .class 69
                           A   137    .value _txFinished
                           A   138    .type 2
                           A   139    .type 0
                           A   140    .endef
000002                     A   141    _command:
000002 00                  A   142    	DB	0
                           A   143    .define "command"
                           A   144    .alias "_command"
                           A   145    .class 69
                           A   146    .value _command
                           A   147    .type 2
                           A   148    .type 0
                           A   149    .endef
000003                     A   150    _rxFlag:
000003 00                  A   151    	DB	0
                           A   152    .define "rxFlag"
                           A   153    .alias "_rxFlag"
                           A   154    .class 69
                           A   155    .value _rxFlag
                           A   156    .type 2
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:   4


PC     Object              I  Line    Source i2c.src
                           A   157    .type 0
                           A   158    .endef
                           A   159    	SEGMENT FAR_BSS
000019                     A   160    _gyroRead:
000019                     A   161    	DS	6
                           A   162    .define "gyroRead"
                           A   163    .alias "_gyroRead"
                           A   164    .class 83
                           A   165    .value _gyroRead
                           A   166    .dim 6
                           A   167    .type 98
                           A   168    .type 0
                           A   169    .endef
00001F                     A   170    _accRead:
00001F                     A   171    	DS	6
                           A   172    .define "accRead"
                           A   173    .alias "_accRead"
                           A   174    .class 83
                           A   175    .value _accRead
                           A   176    .dim 6
                           A   177    .type 98
                           A   178    .type 0
                           A   179    .endef
000025                     A   180    _acc_xh:
000025                     A   181    	DS	1
                           A   182    .define "acc_xh"
                           A   183    .alias "_acc_xh"
                           A   184    .class 83
                           A   185    .value _acc_xh
                           A   186    .type 2
                           A   187    .type 0
                           A   188    .endef
000026                     A   189    _acc_xl:
000026                     A   190    	DS	1
                           A   191    .define "acc_xl"
                           A   192    .alias "_acc_xl"
                           A   193    .class 83
                           A   194    .value _acc_xl
                           A   195    .type 2
                           A   196    .type 0
                           A   197    .endef
000027                     A   198    _acc_yh:
000027                     A   199    	DS	1
                           A   200    .define "acc_yh"
                           A   201    .alias "_acc_yh"
                           A   202    .class 83
                           A   203    .value _acc_yh
                           A   204    .type 2
                           A   205    .type 0
                           A   206    .endef
000028                     A   207    _acc_yl:
000028                     A   208    	DS	1
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:   5


PC     Object              I  Line    Source i2c.src
                           A   209    .define "acc_yl"
                           A   210    .alias "_acc_yl"
                           A   211    .class 83
                           A   212    .value _acc_yl
                           A   213    .type 2
                           A   214    .type 0
                           A   215    .endef
000029                     A   216    _acc_y:
000029                     A   217    	DS	1
                           A   218    .define "acc_y"
                           A   219    .alias "_acc_y"
                           A   220    .class 83
                           A   221    .value _acc_y
                           A   222    .type 2
                           A   223    .type 0
                           A   224    .endef
00002A                     A   225    _acc_x:
00002A                     A   226    	DS	1
                           A   227    .define "acc_x"
                           A   228    .alias "_acc_x"
                           A   229    .class 83
                           A   230    .value _acc_x
                           A   231    .type 2
                           A   232    .type 0
                           A   233    .endef
00002B                     A   234    _gyro_h:
00002B                     A   235    	DS	1
                           A   236    .define "gyro_h"
                           A   237    .alias "_gyro_h"
                           A   238    .class 83
                           A   239    .value _gyro_h
                           A   240    .type 2
                           A   241    .type 0
                           A   242    .endef
00002C                     A   243    _gyro_l:
00002C                     A   244    	DS	1
                           A   245    .define "gyro_l"
                           A   246    .alias "_gyro_l"
                           A   247    .class 83
                           A   248    .value _gyro_l
                           A   249    .type 2
                           A   250    .type 0
                           A   251    .endef
00002D                     A   252    _gyro_val:
00002D                     A   253    	DS	2*1
                           A   254    .define "gyro_val"
                           A   255    .alias "_gyro_val"
                           A   256    .class 83
                           A   257    .value _gyro_val
                           A   258    .type 3
                           A   259    .type 0
                           A   260    .endef
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:   6


PC     Object              I  Line    Source i2c.src
00002F                     A   261    _accXValue:
00002F                     A   262    	DS	2*1
                           A   263    .define "accXValue"
                           A   264    .alias "_accXValue"
                           A   265    .class 83
                           A   266    .value _accXValue
                           A   267    .type 3
                           A   268    .type 0
                           A   269    .endef
000031                     A   270    _accYValue:
000031                     A   271    	DS	2*1
                           A   272    .define "accYValue"
                           A   273    .alias "_accYValue"
                           A   274    .class 83
                           A   275    .value _accYValue
                           A   276    .type 3
                           A   277    .type 0
                           A   278    .endef
000033                     A   279    _accZValue:
000033                     A   280    	DS	2*1
                           A   281    .define "accZValue"
                           A   282    .alias "_accZValue"
                           A   283    .class 83
                           A   284    .value _accZValue
                           A   285    .type 3
                           A   286    .type 0
                           A   287    .endef
000035                     A   288    _gyroXValue:
000035                     A   289    	DS	2*1
                           A   290    .define "gyroXValue"
                           A   291    .alias "_gyroXValue"
                           A   292    .class 83
                           A   293    .value _gyroXValue
                           A   294    .type 3
                           A   295    .type 0
                           A   296    .endef
000037                     A   297    _gyroYValue:
000037                     A   298    	DS	2*1
                           A   299    .define "gyroYValue"
                           A   300    .alias "_gyroYValue"
                           A   301    .class 83
                           A   302    .value _gyroYValue
                           A   303    .type 3
                           A   304    .type 0
                           A   305    .endef
000039                     A   306    _gyroZValue:
000039                     A   307    	DS	2*1
                           A   308    .define "gyroZValue"
                           A   309    .alias "_gyroZValue"
                           A   310    .class 83
                           A   311    .value _gyroZValue
                           A   312    .type 3
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:   7


PC     Object              I  Line    Source i2c.src
                           A   313    .type 0
                           A   314    .endef
00003B                     A   315    _t1Ready:
00003B                     A   316    	DS	1
                           A   317    .define "t1Ready"
                           A   318    .alias "_t1Ready"
                           A   319    .class 83
                           A   320    .value _t1Ready
                           A   321    .type 2
                           A   322    .type 0
                           A   323    .endef
                           A   324    	SEGMENT FAR_DATA
000004                     A   325    _speed:
000004 0000                A   326    	DW	0
                           A   327    .define "speed"
                           A   328    .alias "_speed"
                           A   329    .class 69
                           A   330    .value _speed
                           A   331    .type 3
                           A   332    .type 0
                           A   333    .endef
000006                     A   334    _printI2Cq:
000006 00                  A   335    	DB	0
                           A   336    .define "printI2Cq"
                           A   337    .alias "_printI2Cq"
                           A   338    .class 69
                           A   339    .value _printI2Cq
                           A   340    .type 2
                           A   341    .type 0
                           A   342    .endef
                           A   343    .begrec "NONAME0",7
                           A   344    .define "reading"
                           A   345    .value 0
                           A   346    .class 8
                           A   347    .type 2
                           A   348    .type 0
                           A   349    .endef
                           A   350    .define "cycle"
                           A   351    .value 1
                           A   352    .class 8
                           A   353    .type 2
                           A   354    .type 0
                           A   355    .endef
                           A   356    .define "deviceAddress"
                           A   357    .value 2
                           A   358    .class 8
                           A   359    .type 12
                           A   360    .type 0
                           A   361    .endef
                           A   362    .define "registerAddress"
                           A   363    .value 3
                           A   364    .class 8
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:   8


PC     Object              I  Line    Source i2c.src
                           A   365    .type 12
                           A   366    .type 0
                           A   367    .endef
                           A   368    .define "bytesToRead"
                           A   369    .value 4
                           A   370    .class 8
                           A   371    .type 12
                           A   372    .type 0
                           A   373    .endef
                           A   374    .define "storePtr"
                           A   375    .value 5
                           A   376    .class 8
                           A   377    .type 172
                           A   378    .type 0
                           A   379    .endef
                           A   380    .endrec "NONAME0"
                           A   381    	SEGMENT FAR_BSS
00003C                     A   382    _state:
00003C                     A   383    	DS	7
                           A   384    .define "state"
                           A   385    .alias "_state"
                           A   386    .class 83
                           A   387    .value _state
                           A   388    .tag "NONAME0"
                           A   389    .type 8
                           A   390    .type 0
                           A   391    .endef
                           A   392    	SEGMENT ROM_DATA
                           A   393    
                           A   394    
                           A   395    ;**************************** _i2cInit ********
                           A   396    ;Name                         Addr/Register   S
                           A   397    ;_state                              STATIC    
                           A   398    ;_Si2c_Isr                           IMPORT  --
                           A   399    ;_SET_VECTOR                         IMPORT  --
                           A   400    
                           A   401    
                           A   402    ; Aggregate Stack Size: 0 (words)
                           A   403    
                           A   404    
                           A   405    	.FRAME _n_i2cInit,?_n_i2cInit,RDATA
                           A   406    	.FRAME _f_i2cInit,?_f_i2cInit,EDATA
                           A   407    	SEGMENT i2c_TEXT
000000                     A   408    _i2cInit:
                           A   409    .define "_i2cInit"
                           A   410    .value _i2cInit
                           A   411    .class 2
                           A   412    .type 65
                           A   413    .type 0
                           A   414    .endef
                           A   415    .begfunc "i2cInit",74,"_i2cInit"
000000 D6 0000             A   416    	CALL	__b_frameset00
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:   9


PC     Object              I  Line    Source i2c.src
                           A   417    ;    1	// Code by Brian Bienvenu; Jim Cocks; B
                           A   418    ;    2	
                           A   419    ;    3	#include <eZ8.h>
                           A   420    ;    4	#include <STDIO.H>
                           A   421    ;    5	#include <uart.h>
                           A   422    ;    6	#include "i2c.h"
                           A   423    ;    7	#include <LCD.h>
                           A   424    ;    8	#include <STRING.H>
                           A   425    ;    9	#include <MATH.H>
                           A   426    ;   10	#include <MAIN.H>
                           A   427    ;   11	
                           A   428    ;   12	#define FAIL (0)
                           A   429    ;   13	#define PASS (1)
                           A   430    ;   14	#define AUTO_INC (0x80)
                           A   431    ;   15	#define READ_BIT (0x01)
                           A   432    ;   16	
                           A   433    ;   17	//IC2 Interrupt Enable
                           A   434    ;   18	#define IC2_EI (0x04) //0000 0100
                           A   435    ;   19	
                           A   436    ;   20	//Z8 definitions I2CCTL
                           A   437    ;   21	#define I2CEN_MASK	(0x80)
                           A   438    ;   22	#define START_MASK 	(0x40)
                           A   439    ;   23	#define STOP_MASK  	(0x20)
                           A   440    ;   24	#define TXI_MASK	(0x08)
                           A   441    ;   25	#define NAK_MASK	(0x04)
                           A   442    ;   26	#define FLUSH_MASK 	(0x02)
                           A   443    ;   27	//I2CSTAT
                           A   444    ;   28	#define TDRE_MASK  	(0x80)
                           A   445    ;   29	#define RDRF_MASK	(0x40)
                           A   446    ;   30	#define NCKI_MASK	(0x01)
                           A   447    ;   31	
                           A   448    ;   32	
                           A   449    ;   33	typedef char enum
                           A   450    ;   34	{
                           A   451    ;   35		FAILED = -1,
                           A   452    ;   36		BUSY = 0,
                           A   453    ;   37		DONE = 1
                           A   454    ;   38	} readState_t;
                           A   455    ;   39	
                           A   456    ;   40	typedef char enum
                           A   457    ;   41	{
                           A   458    ;   42		DEV_ADDESS_WRITE,
                           A   459    ;   43		DEV_SUB_ADDRESS,
                           A   460    ;   44		START_READ,
                           A   461    ;   45		DEV_ADDESS_READ,
                           A   462    ;   46		READ_BYTE,
                           A   463    ;   47		READ_LAST,
                           A   464    ;   48		END_CYCLE
                           A   465    ;   49	} cycle_t;
                           A   466    ;   50	
                           A   467    ;   51	typedef struct
                           A   468    ;   52	{
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:  10


PC     Object              I  Line    Source i2c.src
                           A   469    ;   53		readState_t reading;
                           A   470    ;   54		cycle_t cycle;
                           A   471    ;   55		unsigned char deviceAddress;
                           A   472    ;   56		unsigned char registerAddress;
                           A   473    ;   57		unsigned char bytesToRead;
                           A   474    ;   58		unsigned char* storePtr;
                           A   475    ;   59	} i2cState_t;
                           A   476    ;   60	
                           A   477    ;   61	static i2cState_t state;
                           A   478    ;   62	//prototypes
                           A   479    ;   63	void Si2c_Isr(void);
                           A   480    ;   64	
                           A   481    ;   65	/**************************************
                           A   482    ;   66	Description:
                           A   483    ;   67		Initalises the i2c: ports, interrup
                           A   484    ;   68	Notes:
                           A   485    ;   69		doesn't perform and transactions
                           A   486    ;   70	Returns:
                           A   487    ;   71		0 <- fail, 1 pass
                           A   488    ;   72	***************************************
                           A   489    ;   73	void i2cInit(void)
                           A   490    ;   74	{
                           A   491    ;   75		//PA6 and PA7
                           A   492    ;   76		//Set Pins to I2C function
                           A   493    ;   77		PAAF |= 0xC0; 	//1100 0000
                           A   494    .line 77
000003 E9020FD0            A   495    	LDX	4048,#2
000007 49C00FD1            A   496    	ORX	4049,#192
                           A   497    ;   78	
                           A   498    ;   79		//set baud rate
                           A   499    ;   80		I2CBRH = (I2C_BAUD_DIV >> 8);
                           A   500    .line 80
00000B E9000F53            A   501    	LDX	3923,#-0
                           A   502    ;   81		I2CBRL = (I2C_BAUD_DIV & 0xFF);
                           A   503    .line 81
00000F E90C0F54            A   504    	LDX	3924,#12
                           A   505    ;   82	
                           A   506    ;   83		//clear txi
                           A   507    ;   84		I2CCTL &= ~TXI_MASK;
                           A   508    .line 84
000013 59F70F52            A   509    	ANDX	3922,#-9
                           A   510    ;   85		//disable I2C control register
                           A   511    ;   86		I2CCTL &= ~I2CEN_MASK;
                           A   512    .line 86
000017 597F0F52            A   513    	ANDX	3922,#127
                           A   514    ;   87	
                           A   515    ;   88		//set isr for I2C
                           A   516    ;   89		SET_VECTOR(I2C,Si2c_Isr);
                           A   517    ;   90		//set I2C isr to highest priority
                           A   518    ;   91		IRQ0ENH |= IC2_EI;
                           A   519    .line 91
00001B 49040FC1            A   520    	ORX	4033,#4
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:  11


PC     Object              I  Line    Source i2c.src
                           A   521    ;   92		IRQ0ENL |= IC2_EI;
                           A   522    .line 92
00001F 49040FC2            A   523    	ORX	4034,#4
                           A   524    ;   93	
                           A   525    ;   94		//init internal state so it doesn't
                           A   526    ;   95		state.reading = DONE;
                           A   527    .line 95
000023 E901003C            A   528    	LDX	_state,#1
                           A   529    ;   96	}
                           A   530    .line 96
000027 D6 0000             A   531    	CALL	__b_framereset
00002A AF                  A   532    	RET	
                           A   533    .endfunc "i2cInit",96,"_i2cInit"
                           A   534    	SEGMENT ROM_DATA
                           A   535    
                           A   536    
                           A   537    ;**************************** _i2cWrite *******
                           A   538    ;Name                         Addr/Register   S
                           A   539    ;_EI                                 IMPORT  --
                           A   540    ;_DI                                 IMPORT  --
                           A   541    ;ret                                     R0    
                           A   542    ;dataByte                             R15+6    
                           A   543    ;registerAddress                      R15+5    
                           A   544    ;deviceAddress                        R15+4    
                           A   545    
                           A   546    
                           A   547    ; Aggregate Stack Size: 0 (words)
                           A   548    
                           A   549    
                           A   550    	.FRAME _n_i2cWrite,?_n_i2cWrite,RDATA
                           A   551    	.FRAME _f_i2cWrite,?_f_i2cWrite,EDATA
                           A   552    	SEGMENT i2c_TEXT
00002B                     A   553    _i2cWrite:
                           A   554    .define "_i2cWrite"
                           A   555    .value _i2cWrite
                           A   556    .class 2
                           A   557    .type 76
                           A   558    .type 0
                           A   559    .endef
                           A   560    .begfunc "i2cWrite",109,"_i2cWrite"
                           A   561    .define "deviceAddress"
                           A   562    .class 9
                           A   563    .value 4
                           A   564    .type 12
                           A   565    .type 0
                           A   566    .endef
                           A   567    .define "registerAddress"
                           A   568    .class 9
                           A   569    .value 5
                           A   570    .type 12
                           A   571    .type 0
                           A   572    .endef
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:  12


PC     Object              I  Line    Source i2c.src
                           A   573    .define "dataByte"
                           A   574    .class 9
                           A   575    .value 6
                           A   576    .type 12
                           A   577    .type 0
                           A   578    .endef
                           A   579    ;   97	
                           A   580    ;   98	/**************************************
                           A   581    ;   99	Description:
                           A   582    ;  100		Performs single byte i2c write
                           A   583    ;  101	Notes:
                           A   584    ;  102		Is blocking
                           A   585    ;  103		Doesn't use interrupts
                           A   586    ;  104		Don't use while performing a read
                           A   587    ;  105	Returns:
                           A   588    ;  106		1 <= successful, 0 <= failed
                           A   589    ;  107	***************************************
                           A   590    ;  108	unsigned char i2cWrite(unsigned char de
                           A   591    ;  109	{
                           A   592    .define "U‹ìjÿh0/J"
                           A   593    .class 4
                           A   594    .reg 1
                           A   595    .type 12
                           A   596    .type 0
                           A   597    .endef
00002B D6 0000             A   598    	CALL	__b_frameset00
                           A   599    ;  110		unsigned char ret;
                           A   600    ;  111		ret = FAIL;
                           A   601    .line 111
00002E B0E0                A   602    	CLR	R0
                           A   603    ;  112		//disable interrupts
                           A   604    ;  113		DI();
                           A   605    .line 113
000030 8F                  A   606    	DI
                           A   607    ;  114		//enable I2C control register
                           A   608    ;  115		I2CCTL |= I2CEN_MASK;
                           A   609    .line 115
000031 49800F52            A   610    	ORX	3922,#128
                           A   611    ;  116	
                           A   612    ;  117		//wait till TDRE = 1
                           A   613    ;  118		while((I2CSTAT & TDRE_MASK) == 0x00
000035                     A   614    _2_L_1:
                           A   615    .line 118
000035 79800F51            A   616    	TMX	3921,#128
000039 6B FA               A   617    	JR	Z,_2_L_1
                           A   618    ;  119	
                           A   619    ;  120		//write device address to I2C data 
                           A   620    ;  121		I2CDATA = deviceAddress;
                           A   621    .line 121
00003B 881E04              A   622    	LDX	R1,4(RR14)
00003E 941F50              A   623    	LDX	3920,R1
                           A   624    ;  122	
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:  13


PC     Object              I  Line    Source i2c.src
                           A   625    ;  123		//assert start
                           A   626    ;  124		I2CCTL |= START_MASK;
                           A   627    .line 124
000041 49400F52            A   628    	ORX	3922,#64
                           A   629    ;  125	
                           A   630    ;  126		//wait till TDRE = 1
                           A   631    ;  127		while((I2CSTAT & TDRE_MASK) == 0x00
000045                     A   632    _2_L_4:
                           A   633    .line 127
000045 79800F51            A   634    	TMX	3921,#128
000049 6B FA               A   635    	JR	Z,_2_L_4
                           A   636    ;  128	
                           A   637    ;  129		//write device reg address to I2C d
                           A   638    ;  130		I2CDATA = registerAddress;
                           A   639    .line 130
00004B 881E05              A   640    	LDX	R1,5(RR14)
00004E 941F50              A   641    	LDX	3920,R1
                           A   642    ;  131	
                           A   643    ;  132		//wait till TDRE = 1 or error if NC
                           A   644    ;  133		while((I2CSTAT & (NCKI_MASK | TDRE_
000051                     A   645    _2_L_7:
                           A   646    .line 133
000051 79810F51            A   647    	TMX	3921,#129
000055 6B FA               A   648    	JR	Z,_2_L_7
                           A   649    ;  134		if((I2CSTAT & NCKI_MASK) == 0x00)
                           A   650    .line 134
000057 79010F51            A   651    	TMX	3921,#1
00005B EB 18               A   652    	JR	NE,_2_L_16
                           A   653    ;  135		{
                           A   654    ;  136			//write dataByte to I2C data re
                           A   655    ;  137			I2CDATA = dataByte;
                           A   656    .line 137
00005D 881E06              A   657    	LDX	R1,6(RR14)
000060 941F50              A   658    	LDX	3920,R1
                           A   659    ;  138	
                           A   660    ;  139			//wait till TDRE = 1 or error i
                           A   661    ;  140			while((I2CSTAT & (NCKI_MASK | T
000063                     A   662    _2_L_9:
                           A   663    .line 140
000063 79810F51            A   664    	TMX	3921,#129
000067 6B FA               A   665    	JR	Z,_2_L_9
                           A   666    ;  141			if((I2CSTAT & NCKI_MASK) == 0x0
                           A   667    .line 141
000069 79010F51            A   668    	TMX	3921,#1
00006D EB 06               A   669    	JR	NE,_2_L_16
                           A   670    ;  142			{
                           A   671    ;  143				//set stop bit (if got to h
                           A   672    ;  144				I2CCTL |= STOP_MASK;
                           A   673    .line 144
00006F 49200F52            A   674    	ORX	3922,#32
                           A   675    ;  145				ret = PASS;
                           A   676    .line 145
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:  14


PC     Object              I  Line    Source i2c.src
000073 0C01                A   677    	LD	R0,#1
                           A   678    ;  146			}
                           A   679    ;  147		}
000075                     A   680    _2_L_16:
                           A   681    .line 147
                           A   682    ;  148	
                           A   683    ;  149		if(ret == FAIL)
                           A   684    .line 149
000075 4200                A   685    	OR	R0,R0
000077 EB 04               A   686    	JR	NE,_2_L_17
                           A   687    ;  150		{
                           A   688    ;  151			//set stop and flush bits
                           A   689    ;  152			I2CCTL |= (STOP_MASK | FLUSH_MA
                           A   690    .line 152
000079 49220F52            A   691    	ORX	3922,#34
                           A   692    ;  153		}
00007D                     A   693    _2_L_17:
                           A   694    .line 153
                           A   695    ;  154		//disable I2C control register
                           A   696    ;  155		//I2CCTL &= ~I2CEN_MASK;
                           A   697    ;  156		//enable interrupts
                           A   698    ;  157		EI();
                           A   699    .line 157
00007D 9F                  A   700    	EI
                           A   701    ;  158	}
                           A   702    .line 158
00007E D6 0000             A   703    	CALL	__b_framereset
000081 AF                  A   704    	RET	
                           A   705    .endfunc "i2cWrite",158,"_i2cWrite"
                           A   706    	SEGMENT ROM_DATA
                           A   707    
                           A   708    
                           A   709    ;**************************** _i2cStartRead ***
                           A   710    ;Name                         Addr/Register   S
                           A   711    ;_state                              STATIC    
                           A   712    ;dataLoc                              R15+7    
                           A   713    ;numToRead                            R15+6    
                           A   714    ;registerAddress                      R15+5    
                           A   715    ;deviceAddress                        R15+4    
                           A   716    
                           A   717    
                           A   718    ; Aggregate Stack Size: 0 (words)
                           A   719    
                           A   720    
                           A   721    	.FRAME _n_i2cStartRead,?_n_i2cStartRead,RDA
                           A   722    	.FRAME _f_i2cStartRead,?_f_i2cStartRead,EDA
                           A   723    	SEGMENT i2c_TEXT
000082                     A   724    _i2cStartRead:
                           A   725    .define "_i2cStartRead"
                           A   726    .value _i2cStartRead
                           A   727    .class 2
                           A   728    .type 65
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:  15


PC     Object              I  Line    Source i2c.src
                           A   729    .type 0
                           A   730    .endef
                           A   731    .begfunc "i2cStartRead",170,"_i2cStartRead"
                           A   732    .define "deviceAddress"
                           A   733    .class 9
                           A   734    .value 4
                           A   735    .type 12
                           A   736    .type 0
                           A   737    .endef
                           A   738    .define "registerAddress"
                           A   739    .class 9
                           A   740    .value 5
                           A   741    .type 12
                           A   742    .type 0
                           A   743    .endef
                           A   744    .define "numToRead"
                           A   745    .class 9
                           A   746    .value 6
                           A   747    .type 12
                           A   748    .type 0
                           A   749    .endef
                           A   750    .define "dataLoc"
                           A   751    .class 9
                           A   752    .value 7
                           A   753    .type 172
                           A   754    .type 0
                           A   755    .endef
000082 D6 0000             A   756    	CALL	__b_frameset00
                           A   757    ;  159	
                           A   758    ;  160	/**************************************
                           A   759    ;  161	Description:
                           A   760    ;  162		Initiates numToRead i2c reads
                           A   761    ;  163	Notes:
                           A   762    ;  164		uses interrupts
                           A   763    ;  165		use i2cIsDataReady() to check when 
                           A   764    ;  166	Returns:
                           A   765    ;  167		none
                           A   766    ;  168	***************************************
                           A   767    ;  169	void i2cStartRead(unsigned char deviceA
                           A   768    ;  170	{
                           A   769    ;  171		//set reading flag
                           A   770    ;  172		state.reading = BUSY;
                           A   771    .line 172
000085 E900003C            A   772    	LDX	_state,#-0
                           A   773    ;  173		//set internals
                           A   774    ;  174		state.deviceAddress = deviceAddress
                           A   775    .line 174
000089 880E04              A   776    	LDX	R0,4(RR14)
00008C 94003E              A   777    	LDX	_state+2,R0
                           A   778    ;  175		state.registerAddress = registerAdd
                           A   779    .line 175
00008F 880E05              A   780    	LDX	R0,5(RR14)
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:  16


PC     Object              I  Line    Source i2c.src
000092 94003F              A   781    	LDX	_state+3,R0
                           A   782    ;  176		state.bytesToRead = numToRead;
                           A   783    .line 176
000095 880E06              A   784    	LDX	R0,6(RR14)
000098 940040              A   785    	LDX	_state+4,R0
                           A   786    ;  177		state.storePtr = dataLoc;
                           A   787    .line 177
00009B 880E07              A   788    	LDX	R0,7(RR14)
00009E 881E08              A   789    	LDX	R1,8(RR14)
0000A1 940041              A   790    	LDX	_state+5,R0
0000A4 941042              A   791    	LDX	_state+6,R1
                           A   792    ;  178		//set state
                           A   793    ;  179		state.cycle = DEV_ADDESS_WRITE;
                           A   794    .line 179
0000A7 E900003D            A   795    	LDX	_state+1,#-0
                           A   796    ;  180		//assert IEN
                           A   797    ;  181		I2CCTL |= I2CEN_MASK;
                           A   798    .line 181
0000AB 49800F52            A   799    	ORX	3922,#128
                           A   800    ;  182		//assert TXI bit
                           A   801    ;  183		I2CCTL |= TXI_MASK;
                           A   802    .line 183
0000AF 49080F52            A   803    	ORX	3922,#8
                           A   804    ;  184	}
                           A   805    .line 184
0000B3 D6 0000             A   806    	CALL	__b_framereset
0000B6 AF                  A   807    	RET	
                           A   808    .endfunc "i2cStartRead",184,"_i2cStartRead"
                           A   809    	SEGMENT ROM_DATA
                           A   810    
                           A   811    
                           A   812    ;**************************** _mems_read ******
                           A   813    ;Name                         Addr/Register   S
                           A   814    ;_printMessage                       IMPORT  --
                           A   815    ;___print_sputch                     IMPORT  --
                           A   816    ;__u_stoa                            IMPORT  --
                           A   817    ;___print_putromstring               IMPORT  --
                           A   818    ;___print_out                        IMPORT    
                           A   819    ;_printI2CqF                         IMPORT  --
                           A   820    ;_gyroXValue                         STATIC    
                           A   821    ;_0accXValueOld                      STATIC    
                           A   822    ;_accXValue                          STATIC    
                           A   823    ;_gyroRead                           STATIC    
                           A   824    ;_i2cIsDataReady                     IMPORT  --
                           A   825    ;_accRead                            STATIC    
                           A   826    ;_i2cStartRead                       IMPORT  --
                           A   827    ;_i2cWrite                           IMPORT  --
                           A   828    ;oldGyro                        <optimized>    
                           A   829    ;display                             R15-25    
                           A   830    
                           A   831    
                           A   832    ; Aggregate Stack Size: -25 (words)
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:  17


PC     Object              I  Line    Source i2c.src
                           A   833    
                           A   834    
                           A   835    	.FRAME _n_mems_read,?_n_mems_read,RDATA
                           A   836    	.FCALL _n_i2cWrite
                           A   837    	.FCALL _n_i2cStartRead
                           A   838    	.FCALL _n_i2cIsDataReady
                           A   839    	.FCALL _n_printI2CqF
                           A   840    	.FCALL _n___print_putromstring
                           A   841    	.FCALL _n__u_stoa
                           A   842    	.FCALL _n___print_sputch
                           A   843    	.FCALL _n_printMessage
                           A   844    	.FRAME _f_mems_read,?_f_mems_read,EDATA
                           A   845    	.FCALL _f_i2cWrite
                           A   846    	.FCALL _f_i2cStartRead
                           A   847    	.FCALL _f_i2cIsDataReady
                           A   848    	.FCALL _f_printI2CqF
                           A   849    	.FCALL _f___print_putromstring
                           A   850    	.FCALL _f__u_stoa
                           A   851    	.FCALL _f___print_sputch
                           A   852    	.FCALL _f_printMessage
                           A   853    	SEGMENT ROM_TEXT
000000                     A   854    L__17:
000000 41636320            A   855    	DB	"Acc "
000004 00                  A   856    	DB	0
000005                     A   857    L__18:
000005 2C204779 20         A   858    	DB	", Gy "
00000A 00                  A   859    	DB	0
                           A   860    	SEGMENT FAR_BSS
000043                     A   861    _0accXValueOld:
000043                     A   862    	DS	1
                           A   863    	SEGMENT i2c_TEXT
0000B7                     A   864    _mems_read:
                           A   865    .define "_mems_read"
                           A   866    .value _mems_read
                           A   867    .class 2
                           A   868    .type 65
                           A   869    .type 0
                           A   870    .endef
                           A   871    .begfunc "mems_read",187,"_mems_read"
                           A   872    ;  185	
                           A   873    ;  186	//Written with assistance from Ben Ande
                           A   874    ;  187	void mems_read(void){
                           A   875    .define "display"
                           A   876    .class 1
                           A   877    .value -25
                           A   878    .dim 25
                           A   879    .type 98
                           A   880    .type 0
                           A   881    .endef
                           A   882    .define "U‹ìjÿh0/J"
                           A   883    .class 4
                           A   884    .reg -1
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:  18


PC     Object              I  Line    Source i2c.src
                           A   885    .type 2
                           A   886    .type 0
                           A   887    .endef
                           A   888    .define "accXValueOld"
                           A   889    .alias "_0accXValueOld"
                           A   890    .class 83
                           A   891    .value _0accXValueOld
                           A   892    .type 2
                           A   893    .type 0
                           A   894    .endef
0000B7 5C19                A   895    	LD	R5,#25
0000B9 D6 0000             A   896    	CALL	__b_frameset0
                           A   897    ;  188		char display[25];
                           A   898    ;  189		char oldGyro;
                           A   899    ;  190		static char accXValueOld;
                           A   900    ;  191	
                           A   901    ;  192		//Prepare i2c for read
                           A   902    ;  193		i2cWrite(ACCEL, REG1_A_ADDRESS, REG
                           A   903    .line 193
0000BC 1F7097              A   904    	PUSH	#151
0000BF 1F7020              A   905    	PUSH	#32
0000C2 1F7030              A   906    	PUSH	#48
0000C5 D6 002B             A   907    	CALL	_i2cWrite
0000C8 50E0                A   908    	POP	R0
0000CA 50E0                A   909    	POP	R0
0000CC 50E0                A   910    	POP	R0
                           A   911    ;  194		i2cWrite(ACCEL, REG4_A_ADDRESS, REG
                           A   912    .line 194
0000CE 1F7048              A   913    	PUSH	#72
0000D1 1F7023              A   914    	PUSH	#35
0000D4 1F7030              A   915    	PUSH	#48
0000D7 D6 002B             A   916    	CALL	_i2cWrite
0000DA 50E0                A   917    	POP	R0
0000DC 50E0                A   918    	POP	R0
0000DE 50E0                A   919    	POP	R0
                           A   920    ;  195		i2cWrite(GYRO, REG1_G_ADDRESS, REG1
                           A   921    .line 195
0000E0 1F70FF              A   922    	PUSH	#255
0000E3 1F7020              A   923    	PUSH	#32
0000E6 1F70D4              A   924    	PUSH	#212
0000E9 D6 002B             A   925    	CALL	_i2cWrite
0000EC 50E0                A   926    	POP	R0
0000EE 50E0                A   927    	POP	R0
0000F0 50E0                A   928    	POP	R0
                           A   929    ;  196		i2cWrite(GYRO, REG4_G_ADDRESS, REG4
                           A   930    .line 196
0000F2 1F7040              A   931    	PUSH	#64
0000F5 1F7023              A   932    	PUSH	#35
0000F8 1F70D4              A   933    	PUSH	#212
0000FB D6 002B             A   934    	CALL	_i2cWrite
0000FE 50E0                A   935    	POP	R0
000100 50E0                A   936    	POP	R0
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:  19


PC     Object              I  Line    Source i2c.src
000102 50E0                A   937    	POP	R0
                           A   938    ;  197		i2cWrite(GYRO, REG5_G_ADDRESS, REG5
                           A   939    .line 197
000104 1F7010              A   940    	PUSH	#16
000107 1F7024              A   941    	PUSH	#36
00010A 1F70D4              A   942    	PUSH	#212
00010D D6 002B             A   943    	CALL	_i2cWrite
000110 50E0                A   944    	POP	R0
000112 50E0                A   945    	POP	R0
000114 50E0                A   946    	POP	R0
                           A   947    ;  198	
                           A   948    ;  199		//Read the disired value from the m
                           A   949    ;  200		i2cStartRead(ACCEL, X_LOW_ADDRESS, 
                           A   950    .line 200
000116 1F70 1F             A   951    	PUSH	#low(_accRead)
000119 1F70 00             A   952    	PUSH	#high(_accRead)
00011C 1F7006              A   953    	PUSH	#6
00011F 1F7028              A   954    	PUSH	#40
000122 1F7030              A   955    	PUSH	#48
000125 D6 0082             A   956    	CALL	_i2cStartRead
000128 50E0                A   957    	POP	R0
00012A 50E0                A   958    	POP	R0
00012C 50E0                A   959    	POP	R0
00012E 50E0                A   960    	POP	R0
000130 50E0                A   961    	POP	R0
                           A   962    ;  201	// 	i2cStartRead(ACCEL, X_HIGH_ADDRESS,
                           A   963    ;  202	//Make sure the i2c communicationis fin
                           A   964    ;  203		while(i2cIsDataReady()==0){}
000132                     A   965    _4_L_20:
                           A   966    .line 203
000132 D6 0427             A   967    	CALL	_i2cIsDataReady
000135 4200                A   968    	OR	R0,R0
000137 6B F9               A   969    	JR	Z,_4_L_20
                           A   970    ;  204	
                           A   971    ;  205		i2cStartRead(GYRO, RATE_LOW_ADDRESS
                           A   972    .line 205
000139 1F70 19             A   973    	PUSH	#low(_gyroRead)
00013C 1F70 00             A   974    	PUSH	#high(_gyroRead)
00013F 1F7006              A   975    	PUSH	#6
000142 1F7028              A   976    	PUSH	#40
000145 1F70D4              A   977    	PUSH	#212
000148 D6 0082             A   978    	CALL	_i2cStartRead
00014B 50E0                A   979    	POP	R0
00014D 50E0                A   980    	POP	R0
00014F 50E0                A   981    	POP	R0
000151 50E0                A   982    	POP	R0
000153 50E0                A   983    	POP	R0
                           A   984    ;  206		while(i2cIsDataReady()==0){}
000155                     A   985    _4_L_23:
                           A   986    .line 206
000155 D6 0427             A   987    	CALL	_i2cIsDataReady
000158 4200                A   988    	OR	R0,R0
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:  20


PC     Object              I  Line    Source i2c.src
00015A 6B F9               A   989    	JR	Z,_4_L_23
                           A   990    ;  207	
                           A   991    ;  208		//Assemble the bits into a useable 
                           A   992    ;  209		accXValue = accRead[1] & ((accRead[
                           A   993    .line 209
00015C 841020              A   994    	LDX	R1,_accRead+1
00015F E4E1E0              A   995    	LD	R0,R1
000162 90E0                A   996    	RL	R0
000164 3200                A   997    	SBC	R0,R0
000166 E8 01F02F           A   998    	LDX	_accXValue,_accRead
00016A E9000030            A   999    	LDX	_accXValue+1,#-0
00016E 58EE1030            A  1000    	ANDX	_accXValue+1,R1
000172 58EE002F            A  1001    	ANDX	_accXValue,R0
                           A  1002    ;  210	
                           A  1003    ;  211		if(accXValue == 0){
                           A  1004    .line 211
000176 84002F              A  1005    	LDX	R0,_accXValue
000179 48 030EE0           A  1006    	ORX	R0,_accXValue+1
00017D EB 12               A  1007    	JR	NE,_4_L_27
                           A  1008    ;  212			accXValue = accXValueOld;
                           A  1009    .line 212
00017F 841043              A  1010    	LDX	R1,_0accXValueOld
000182 E4E1E0              A  1011    	LD	R0,R1
000185 90E0                A  1012    	RL	R0
000187 3200                A  1013    	SBC	R0,R0
000189 94002F              A  1014    	LDX	_accXValue,R0
00018C 941030              A  1015    	LDX	_accXValue+1,R1
                           A  1016    ;  213		} else {
                           A  1017    .line 213
00018F 8B 04               A  1018    	JR	_4_L_28
000191                     A  1019    _4_L_27:
                           A  1020    ;  214			accXValueOld = accXValue;
                           A  1021    .line 214
000191 E8 030043           A  1022    	LDX	_0accXValueOld,_accXValue+1
                           A  1023    ;  215		}
000195                     A  1024    _4_L_28:
                           A  1025    .line 215
                           A  1026    ;  216	
                           A  1027    ;  217		// accYValue = accRead[3] & ((accRe
                           A  1028    ;  218		// accZValue = accRead[5] & ((accRe
                           A  1029    ;  219		gyroXValue = gyroRead[1] & ((gyroRe
                           A  1030    .line 219
000195 84101A              A  1031    	LDX	R1,_gyroRead+1
000198 E4E1E0              A  1032    	LD	R0,R1
00019B 90E0                A  1033    	RL	R0
00019D 3200                A  1034    	SBC	R0,R0
00019F E8 019035           A  1035    	LDX	_gyroXValue,_gyroRead
0001A3 E9000036            A  1036    	LDX	_gyroXValue+1,#-0
0001A7 58EE1036            A  1037    	ANDX	_gyroXValue+1,R1
0001AB 58EE0035            A  1038    	ANDX	_gyroXValue,R0
                           A  1039    ;  220		// gyroYValue = gyroRead[2] & ((gyr
                           A  1040    ;  221		// gyroZValue = gyroRead[4] & ((gyr
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:  21


PC     Object              I  Line    Source i2c.src
                           A  1041    ;  222	
                           A  1042    ;  223		//If main says to print the values,
                           A  1043    ;  224		if(printI2CqF()){
                           A  1044    .line 224
0001AF D6 0000             A  1045    	CALL	_printI2CqF
0001B2 4200                A  1046    	OR	R0,R0
0001B4 6B 62               A  1047    	JR	Z,_4_L_30
                           A  1048    ;  225			sprintf(display, "Acc %d, Gy %d
                           A  1049    .line 225
0001B6 1CFF                A  1050    	LD	R1,#255
0001B8 0CE7                A  1051    	LD	R0,#231
0001BA 020F                A  1052    	ADD	R0,R15
0001BC 121E                A  1053    	ADC	R1,R14
0001BE 941000              A  1054    	LDX	___print_out,R1
0001C1 940001              A  1055    	LDX	___print_out+1,R0
0001C4 1F70 00             A  1056    	PUSH	#low(L__17)
0001C7 1F70 00             A  1057    	PUSH	#high(L__17)
0001CA D6 0000             A  1058    	CALL	___print_putromstring
0001CD 50E0                A  1059    	POP	R0
0001CF 50E0                A  1060    	POP	R0
0001D1 C8 0300             A  1061    	PUSHX	_accXValue+1
0001D4 C8 02F0             A  1062    	PUSHX	_accXValue
0001D7 D6 0000             A  1063    	CALL	__u_stoa
0001DA 50E0                A  1064    	POP	R0
0001DC 50E0                A  1065    	POP	R0
0001DE 1F70 05             A  1066    	PUSH	#low(L__18)
0001E1 1F70 00             A  1067    	PUSH	#high(L__18)
0001E4 D6 0000             A  1068    	CALL	___print_putromstring
0001E7 50E0                A  1069    	POP	R0
0001E9 50E0                A  1070    	POP	R0
0001EB C8 0360             A  1071    	PUSHX	_gyroXValue+1
0001EE C8 0350             A  1072    	PUSHX	_gyroXValue
0001F1 D6 0000             A  1073    	CALL	__u_stoa
0001F4 50E0                A  1074    	POP	R0
0001F6 50E0                A  1075    	POP	R0
0001F8 1F7000              A  1076    	PUSH	#0
0001FB D6 0000             A  1077    	CALL	___print_sputch
0001FE 50E0                A  1078    	POP	R0
                           A  1079    ;  226			printMessage(display, 1);
                           A  1080    .line 226
000200 1F7001              A  1081    	PUSH	#1
000203 1CFF                A  1082    	LD	R1,#255
000205 0CE7                A  1083    	LD	R0,#231
000207 020F                A  1084    	ADD	R0,R15
000209 121E                A  1085    	ADC	R1,R14
00020B 70E0                A  1086    	PUSH	R0
00020D 70E1                A  1087    	PUSH	R1
00020F D6 0000             A  1088    	CALL	_printMessage
000212 50E0                A  1089    	POP	R0
000214 50E0                A  1090    	POP	R0
000216 50E0                A  1091    	POP	R0
                           A  1092    ;  227			oldGyro = gyroXValue;
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:  22


PC     Object              I  Line    Source i2c.src
                           A  1093    .line 227
                           A  1094    ;  228		}
                           A  1095    ;  229	}
000218                     A  1096    _4_L_30:
                           A  1097    .line 229
000218 D6 0000             A  1098    	CALL	__b_framereset
00021B AF                  A  1099    	RET	
                           A  1100    .endfunc "mems_read",229,"_mems_read"
                           A  1101    	SEGMENT ROM_DATA
                           A  1102    
                           A  1103    
                           A  1104    ;**************************** _complementary **
                           A  1105    ;Name                         Addr/Register   S
                           A  1106    ;_accXValue                          STATIC    
                           A  1107    ;_accZValue                          STATIC    
                           A  1108    ;_atan2                              IMPORT  --
                           A  1109    ;_gyroXValue                         STATIC    
                           A  1110    ;thetaAcc                            R15-12    
                           A  1111    ;thetaGyro                            R15-8    
                           A  1112    ;theta                                R15-4    
                           A  1113    
                           A  1114    
                           A  1115    ; Aggregate Stack Size: -12 (words)
                           A  1116    
                           A  1117    
                           A  1118    	.FRAME _n_complementary,?_n_complementary,R
                           A  1119    	.FCALL _n_atan2
                           A  1120    	.FRAME _f_complementary,?_f_complementary,E
                           A  1121    	.FCALL _f_atan2
                           A  1122    	SEGMENT i2c_TEXT
00021C                     A  1123    _complementary:
                           A  1124    .define "_complementary"
                           A  1125    .value _complementary
                           A  1126    .class 2
                           A  1127    .type 70
                           A  1128    .type 0
                           A  1129    .endef
                           A  1130    .begfunc "complementary",232,"_complementary"
                           A  1131    ;  230	
                           A  1132    ;  231	//Written by myself with assitence from
                           A  1133    ;  232	float complementary(void){
                           A  1134    .define "theta"
                           A  1135    .class 1
                           A  1136    .value -4
                           A  1137    .type 6
                           A  1138    .type 0
                           A  1139    .endef
                           A  1140    .define "thetaGyro"
                           A  1141    .class 1
                           A  1142    .value -8
                           A  1143    .type 6
                           A  1144    .type 0
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:  23


PC     Object              I  Line    Source i2c.src
                           A  1145    .endef
                           A  1146    .define "thetaAcc"
                           A  1147    .class 1
                           A  1148    .value -12
                           A  1149    .type 6
                           A  1150    .type 0
                           A  1151    .endef
00021C 5C0C                A  1152    	LD	R5,#12
00021E D6 0000             A  1153    	CALL	__b_frameset0
                           A  1154    ;  233		float thetaGyro = 0;
                           A  1155    .line 233
000221 B0E0                A  1156    	CLR	R0
000223 B0E1                A  1157    	CLR	R1
000225 B0E2                A  1158    	CLR	R2
000227 B0E3                A  1159    	CLR	R3
000229 89E0F8              A  1160    	LDX	-8(RR14),R0
00022C 89E1F9              A  1161    	LDX	-7(RR14),R1
00022F 89E2FA              A  1162    	LDX	-6(RR14),R2
000232 89E3FB              A  1163    	LDX	-5(RR14),R3
                           A  1164    ;  234		float thetaAcc = 0;
                           A  1165    .line 234
000235 B0E0                A  1166    	CLR	R0
000237 B0E1                A  1167    	CLR	R1
000239 B0E2                A  1168    	CLR	R2
00023B B0E3                A  1169    	CLR	R3
00023D 89E0F4              A  1170    	LDX	-12(RR14),R0
000240 89E1F5              A  1171    	LDX	-11(RR14),R1
000243 89E2F6              A  1172    	LDX	-10(RR14),R2
000246 89E3F7              A  1173    	LDX	-9(RR14),R3
                           A  1174    ;  235		float theta = 0;
                           A  1175    .line 235
000249 B0E0                A  1176    	CLR	R0
00024B B0E1                A  1177    	CLR	R1
00024D B0E2                A  1178    	CLR	R2
00024F B0E3                A  1179    	CLR	R3
000251 89E0FC              A  1180    	LDX	-4(RR14),R0
000254 89E1FD              A  1181    	LDX	-3(RR14),R1
000257 89E2FE              A  1182    	LDX	-2(RR14),R2
00025A 89E3FF              A  1183    	LDX	-1(RR14),R3
                           A  1184    ;  236	
                           A  1185    ;  237		//Integrate gyro
                           A  1186    ;  238		thetaGyro += (float) gyroXValue * 0
                           A  1187    .line 238
00025D 843036              A  1188    	LDX	R3,_gyroXValue+1
000260 842035              A  1189    	LDX	R2,_gyroXValue
000263 E4E2E1              A  1190    	LD	R1,R2
000266 90E1                A  1191    	RL	R1
000268 3211                A  1192    	SBC	R1,R1
00026A E4E1E0              A  1193    	LD	R0,R1
00026D D6 0000             A  1194    	CALL	__b_fpltof
000270 4C3D                A  1195    	LD	R4,#61
000272 5C23                A  1196    	LD	R5,#35
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:  24


PC     Object              I  Line    Source i2c.src
000274 6CD7                A  1197    	LD	R6,#215
000276 7C0A                A  1198    	LD	R7,#10
000278 D6 0000             A  1199    	CALL	__b_fpmul
00027B 1FE8EE0E E4         A  1200    	LDWX	RR4,RR0
000280 1FE8EE2E E6         A  1201    	LDWX	RR6,RR2
000285 990EF8              A  1202    	LEA	RR0,248(RR14)
000288 D6 0000             A  1203    	CALL	__b_ldxlr0
00028B D6 0000             A  1204    	CALL	__b_fpadd
00028E 994EF8              A  1205    	LEA	RR4,248(RR14)
000291 D6 0000             A  1206    	CALL	__b_stxlr0
                           A  1207    ;  239	
                           A  1208    ;  240		//Angle from accelerometer based on
                           A  1209    ;  241		thetaAcc = atan2((float) accXValue,
                           A  1210    .line 241
000294 843034              A  1211    	LDX	R3,_accZValue+1
000297 842033              A  1212    	LDX	R2,_accZValue
00029A E4E2E1              A  1213    	LD	R1,R2
00029D 90E1                A  1214    	RL	R1
00029F 3211                A  1215    	SBC	R1,R1
0002A1 E4E1E0              A  1216    	LD	R0,R1
0002A4 D6 0000             A  1217    	CALL	__b_fpltof
0002A7 4C42                A  1218    	LD	R4,#66
0002A9 5C65                A  1219    	LD	R5,#101
0002AB 6C47                A  1220    	LD	R6,#71
0002AD 7CAE                A  1221    	LD	R7,#174
0002AF D6 0000             A  1222    	CALL	__b_fpmul
0002B2 70E3                A  1223    	PUSH	R3
0002B4 70E2                A  1224    	PUSH	R2
0002B6 70E1                A  1225    	PUSH	R1
0002B8 70E0                A  1226    	PUSH	R0
0002BA 843030              A  1227    	LDX	R3,_accXValue+1
0002BD 84202F              A  1228    	LDX	R2,_accXValue
0002C0 E4E2E1              A  1229    	LD	R1,R2
0002C3 90E1                A  1230    	RL	R1
0002C5 3211                A  1231    	SBC	R1,R1
0002C7 E4E1E0              A  1232    	LD	R0,R1
0002CA D6 0000             A  1233    	CALL	__b_fpltof
0002CD 70E3                A  1234    	PUSH	R3
0002CF 70E2                A  1235    	PUSH	R2
0002D1 70E1                A  1236    	PUSH	R1
0002D3 70E0                A  1237    	PUSH	R0
0002D5 D6 0000             A  1238    	CALL	_atan2
0002D8 2F                  A  1239    	ATM	
0002D9 09080FFF            A  1240    	ADDX	4095,#8
0002DD 19000FFE            A  1241    	ADCX	4094,#-0
0002E1 89E0F4              A  1242    	LDX	-12(RR14),R0
0002E4 89E1F5              A  1243    	LDX	-11(RR14),R1
0002E7 89E2F6              A  1244    	LDX	-10(RR14),R2
0002EA 89E3F7              A  1245    	LDX	-9(RR14),R3
                           A  1246    ;  242	
                           A  1247    ;  243		theta = 0.98*(thetaGyro + theta) + 
                           A  1248    .line 243
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:  25


PC     Object              I  Line    Source i2c.src
0002ED 994EFC              A  1249    	LEA	RR4,252(RR14)
0002F0 D6 0000             A  1250    	CALL	__b_ldxlr4
0002F3 990EF8              A  1251    	LEA	RR0,248(RR14)
0002F6 D6 0000             A  1252    	CALL	__b_ldxlr0
0002F9 D6 0000             A  1253    	CALL	__b_fpadd
0002FC 4C3F                A  1254    	LD	R4,#63
0002FE 5C7A                A  1255    	LD	R5,#122
000300 6CE1                A  1256    	LD	R6,#225
000302 7C48                A  1257    	LD	R7,#72
000304 D6 0000             A  1258    	CALL	__b_fpmul
000307 1FE8EE0E E8         A  1259    	LDWX	RR8,RR0
00030C 1FE8EE2E EA         A  1260    	LDWX	RR10,RR2
000311 4C3C                A  1261    	LD	R4,#60
000313 5CA3                A  1262    	LD	R5,#163
000315 6CD7                A  1263    	LD	R6,#215
000317 7C0A                A  1264    	LD	R7,#10
000319 990EF4              A  1265    	LEA	RR0,244(RR14)
00031C D6 0000             A  1266    	CALL	__b_ldxlr0
00031F D6 0000             A  1267    	CALL	__b_fpmul
000322 1FE8EE0E E4         A  1268    	LDWX	RR4,RR0
000327 1FE8EE2E E6         A  1269    	LDWX	RR6,RR2
00032C 1FE8EE8E E0         A  1270    	LDWX	RR0,RR8
000331 1FE8EEAE E2         A  1271    	LDWX	RR2,RR10
000336 D6 0000             A  1272    	CALL	__b_fpadd
000339 994EFC              A  1273    	LEA	RR4,252(RR14)
00033C D6 0000             A  1274    	CALL	__b_stxlr0
                           A  1275    ;  244	
                           A  1276    ;  245		return theta;
                           A  1277    .line 245
00033F 990EFC              A  1278    	LEA	RR0,252(RR14)
000342 D6 0000             A  1279    	CALL	__b_ldxlr0
                           A  1280    ;  246	}
                           A  1281    .line 246
000345 D6 0000             A  1282    	CALL	__b_framereset
000348 AF                  A  1283    	RET	
                           A  1284    .endfunc "complementary",246,"_complementary"
                           A  1285    	SEGMENT ROM_DATA
                           A  1286    ;	Jump Table for Switch Statement at line 292
000000                     A  1287    L__26:
000000 0004                A  1288    	DW	4
000002 0000                A  1289    	DW	0
000004 03AB                A  1290    	DW	_6_L_34
000006 0001                A  1291    	DW	1
000008 03BD                A  1292    	DW	_6_L_35
00000A 0002                A  1293    	DW	2
00000C 03D7                A  1294    	DW	_6_L_39
00000E 0004                A  1295    	DW	4
000010 03FD                A  1296    	DW	_6_L_43
000012 0423                A  1297    	DW	_6_L_52
                           A  1298    
                           A  1299    
                           A  1300    ;**************************** _Si2c_Isr *******
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:  26


PC     Object              I  Line    Source i2c.src
                           A  1301    ;Name                         Addr/Register   S
                           A  1302    ;_state                              STATIC    
                           A  1303    
                           A  1304    
                           A  1305    ; Aggregate Stack Size: 0 (words)
                           A  1306    
                           A  1307    
                           A  1308    	.FRAME _n_Si2c_Isr,?_n_Si2c_Isr,RDATA
                           A  1309    	.FRAME _f_Si2c_Isr,?_f_Si2c_Isr,EDATA
                           A  1310    	SEGMENT i2c_TEXT
000349                     A  1311    _Si2c_Isr:
                           A  1312    .define "_Si2c_Isr"
                           A  1313    .value _Si2c_Isr
                           A  1314    .class 2
                           A  1315    .type 65
                           A  1316    .type 0
                           A  1317    .endef
                           A  1318    .begfunc "Si2c_Isr",257,"_Si2c_Isr"
000349 C8FFD0              A  1319    	PUSHX	4093
00034C D6 0000             A  1320    	CALL	__b_iframeset00
                           A  1321    ;  247	
                           A  1322    ;  248	/**************************************
                           A  1323    ;  249	Description: State machine handles
                           A  1324    ;  250			Nack interrupt
                           A  1325    ;  251			Empty Interrupt
                           A  1326    ;  252			Recieve interrupt
                           A  1327    ;  253	
                           A  1328    ;  254	***************************************
                           A  1329    ;  255	#pragma interrupt
                           A  1330    ;  256	void Si2c_Isr(void)
                           A  1331    ;  257	{
                           A  1332    ;  258		//Disable Interrupts
                           A  1333    ;  259		if(I2CSTAT & NCKI_MASK) //not ack i
                           A  1334    .line 259
00034F 79010F51            A  1335    	TMX	3921,#1
000353 6B 3C               A  1336    	JR	Z,_6_L_51
                           A  1337    ;  260		{
                           A  1338    ;  261			//in read last byte statwe
                           A  1339    ;  262			if(state.cycle == READ_LAST)
                           A  1340    .line 262
000355 A905003D            A  1341    	CPX	_state+1,#5
000359 EB 1F               A  1342    	JR	NE,_6_L_33
                           A  1343    ;  263			{
                           A  1344    ;  264				//read i2c data
                           A  1345    ;  265				*(state.storePtr) = I2CDATA
                           A  1346    .line 265
00035B 840041              A  1347    	LDX	R0,_state+5
00035E 841042              A  1348    	LDX	R1,_state+6
000361 842F50              A  1349    	LDX	R2,3920
000364 96E2E0              A  1350    	LDX	@RR0,R2
                           A  1351    ;  266				//assert stop
                           A  1352    ;  267				I2CCTL |= STOP_MASK;
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:  27


PC     Object              I  Line    Source i2c.src
                           A  1353    .line 267
000367 49200F52            A  1354    	ORX	3922,#32
                           A  1355    ;  268				//read cycle completed
                           A  1356    ;  269				state.cycle = END_CYCLE;
                           A  1357    .line 269
00036B E906003D            A  1358    	LDX	_state+1,#6
                           A  1359    ;  270				//clear reading ass samples
                           A  1360    ;  271				state.reading  = DONE;
                           A  1361    .line 271
00036F E901003C            A  1362    	LDX	_state,#1
                           A  1363    ;  272				//disable i2c
                           A  1364    ;  273				I2CCTL &= ~I2CEN_MASK;
                           A  1365    .line 273
000373 597F0F52            A  1366    	ANDX	3922,#127
                           A  1367    ;  274			}
                           A  1368    ;  275			else
                           A  1369    .line 275
000377 8D 04 23            A  1370    	JR	_6_L_52
00037A                     A  1371    _6_L_33:
                           A  1372    ;  276			{
                           A  1373    ;  277				//error
                           A  1374    ;  278				//set stop and flush bits
                           A  1375    ;  279				I2CCTL |= (STOP_MASK | FLUS
                           A  1376    .line 279
00037A 49220F52            A  1377    	ORX	3922,#34
                           A  1378    ;  280				//clear txi
                           A  1379    ;  281				I2CCTL &= ~TXI_MASK;
                           A  1380    .line 281
00037E 59F70F52            A  1381    	ANDX	3922,#-9
                           A  1382    ;  282				//reset state
                           A  1383    ;  283				state.cycle = END_CYCLE;
                           A  1384    .line 283
000382 E906003D            A  1385    	LDX	_state+1,#6
                           A  1386    ;  284				//report failure
                           A  1387    ;  285				state.reading  = FAILED;
                           A  1388    .line 285
000386 E9FF003C            A  1389    	LDX	_state,#-1
                           A  1390    ;  286				//disable i2c
                           A  1391    ;  287				I2CCTL &= ~I2CEN_MASK;
                           A  1392    .line 287
00038A 597F0F52            A  1393    	ANDX	3922,#127
                           A  1394    ;  288			}
                           A  1395    ;  289		}
                           A  1396    ;  290		else if(I2CSTAT & (TDRE_MASK| RDRF_
                           A  1397    .line 290
00038E 8D 04 23            A  1398    	JR	_6_L_52
000391                     A  1399    _6_L_51:
000391 79C00F51            A  1400    	TMX	3921,#192
000395 6D 04 23            A  1401    	JR	Z,_6_L_52
                           A  1402    ;  291		{
                           A  1403    ;  292			switch (state.cycle)
                           A  1404    .line 292
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:  28


PC     Object              I  Line    Source i2c.src
000398 84103D              A  1405    	LDX	R1,_state+1
00039B E4E1E0              A  1406    	LD	R0,R1
00039E 90E0                A  1407    	RL	R0
0003A0 3200                A  1408    	SBC	R0,R0
0003A2 2C 00               A  1409    	LD	R2,#high(L__26)
0003A4 3C 00               A  1410    	LD	R3,#low(L__26)
0003A6 D6 0000             A  1411    	CALL	__b_ucase
0003A9 C4E0                A  1412    	JP	@RR0
                           A  1413    ;  293			{
                           A  1414    ;  294				case DEV_ADDESS_WRITE:
0003AB                     A  1415    _6_L_34:
                           A  1416    .line 294
                           A  1417    ;  295					//write device address 
                           A  1418    ;  296					I2CDATA = state.deviceA
                           A  1419    .line 296
0003AB 84003E              A  1420    	LDX	R0,_state+2
0003AE E200                A  1421    	BCLR	0,R0
0003B0 940F50              A  1422    	LDX	3920,R0
                           A  1423    ;  297					//assert start
                           A  1424    ;  298					I2CCTL |= START_MASK;
                           A  1425    .line 298
0003B3 49400F52            A  1426    	ORX	3922,#64
                           A  1427    ;  299					//set to next state
                           A  1428    ;  300					state.cycle = DEV_SUB_A
                           A  1429    .line 300
0003B7 E901003D            A  1430    	LDX	_state+1,#1
                           A  1431    ;  301					break;
                           A  1432    .line 301
0003BB 8B 66               A  1433    	JR	_6_L_52
                           A  1434    ;  302				case DEV_SUB_ADDRESS:
0003BD                     A  1435    _6_L_35:
                           A  1436    .line 302
                           A  1437    ;  303					if(state.bytesToRead > 
                           A  1438    .line 303
0003BD A9010040            A  1439    	CPX	_state+4,#1
0003C1 3B 0A               A  1440    	JR	ULE,_6_L_37
                           A  1441    ;  304					{
                           A  1442    ;  305						//set first bit to 
                           A  1443    ;  306						I2CDATA = AUTO_INC 
                           A  1444    .line 306
0003C3 84003F              A  1445    	LDX	R0,_state+3
0003C6 E2F0                A  1446    	BSET	7,R0
0003C8 940F50              A  1447    	LDX	3920,R0
                           A  1448    ;  307					}
                           A  1449    ;  308					else
                           A  1450    .line 308
0003CB 8B 04               A  1451    	JR	_6_L_38
0003CD                     A  1452    _6_L_37:
                           A  1453    ;  309					{
                           A  1454    ;  310						//write device sub 
                           A  1455    ;  311						I2CDATA = state.reg
                           A  1456    .line 311
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:  29


PC     Object              I  Line    Source i2c.src
0003CD E8 03FF50           A  1457    	LDX	3920,_state+3
                           A  1458    ;  312					}
0003D1                     A  1459    _6_L_38:
                           A  1460    .line 312
                           A  1461    ;  313					//need to wait till i2c
                           A  1462    ;  314					//set to next state
                           A  1463    ;  315					state.cycle = START_REA
                           A  1464    .line 315
0003D1 E902003D            A  1465    	LDX	_state+1,#2
                           A  1466    ;  316					break;
                           A  1467    .line 316
0003D5 8B 4C               A  1468    	JR	_6_L_52
                           A  1469    ;  317				case START_READ:
0003D7                     A  1470    _6_L_39:
                           A  1471    .line 317
                           A  1472    ;  318					//commence read cycle
                           A  1473    ;  319					//write device address 
                           A  1474    ;  320					I2CDATA = state.deviceA
                           A  1475    .line 320
0003D7 84003E              A  1476    	LDX	R0,_state+2
0003DA E280                A  1477    	BSET	0,R0
0003DC 940F50              A  1478    	LDX	3920,R0
                           A  1479    ;  321					//assert start
                           A  1480    ;  322					I2CCTL |= START_MASK;
                           A  1481    .line 322
0003DF 49400F52            A  1482    	ORX	3922,#64
                           A  1483    ;  323					//clear TXI (stops tran
                           A  1484    ;  324					I2CCTL &= ~TXI_MASK;
                           A  1485    .line 324
0003E3 59F70F52            A  1486    	ANDX	3922,#-9
                           A  1487    ;  325					if(state.bytesToRead ==
                           A  1488    .line 325
0003E7 A9010040            A  1489    	CPX	_state+4,#1
0003EB EB 0A               A  1490    	JR	NE,_6_L_41
                           A  1491    ;  326					{
                           A  1492    ;  327						//set state to read
                           A  1493    ;  328						state.cycle = READ_
                           A  1494    .line 328
0003ED E905003D            A  1495    	LDX	_state+1,#5
                           A  1496    ;  329						//set NACK bit will
                           A  1497    ;  330						I2CCTL |= NAK_MASK;
                           A  1498    .line 330
0003F1 49040F52            A  1499    	ORX	3922,#4
                           A  1500    ;  331					}
                           A  1501    ;  332					else
                           A  1502    .line 332
0003F5 8B 2C               A  1503    	JR	_6_L_52
0003F7                     A  1504    _6_L_41:
                           A  1505    ;  333					{
                           A  1506    ;  334						//set state to read
                           A  1507    ;  335						state.cycle = READ_
                           A  1508    .line 335
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:  30


PC     Object              I  Line    Source i2c.src
0003F7 E904003D            A  1509    	LDX	_state+1,#4
                           A  1510    ;  336					}
                           A  1511    .line 336
                           A  1512    ;  337	
                           A  1513    ;  338					break;
                           A  1514    .line 338
0003FB 8B 26               A  1515    	JR	_6_L_52
                           A  1516    ;  339				case READ_BYTE:
0003FD                     A  1517    _6_L_43:
                           A  1518    .line 339
                           A  1519    ;  340					//read i2c data
                           A  1520    ;  341					*(state.storePtr) = I2C
                           A  1521    .line 341
0003FD 840041              A  1522    	LDX	R0,_state+5
000400 841042              A  1523    	LDX	R1,_state+6
000403 842F50              A  1524    	LDX	R2,3920
000406 96E2E0              A  1525    	LDX	@RR0,R2
                           A  1526    ;  342					//move next location
                           A  1527    ;  343					state.storePtr++;
                           A  1528    .line 343
000409 09010042            A  1529    	ADDX	_state+6,#1
00040D 19000041            A  1530    	ADCX	_state+5,#-0
                           A  1531    ;  344					state.bytesToRead--;
                           A  1532    .line 344
000411 29010040            A  1533    	SUBX	_state+4,#1
                           A  1534    ;  345					if(state.bytesToRead ==
                           A  1535    .line 345
000415 A9010040            A  1536    	CPX	_state+4,#1
000419 EB 08               A  1537    	JR	NE,_6_L_47
                           A  1538    ;  346					{
                           A  1539    ;  347						//set NACK bit will
                           A  1540    ;  348						I2CCTL |= NAK_MASK;
                           A  1541    .line 348
00041B 49040F52            A  1542    	ORX	3922,#4
                           A  1543    ;  349						//set state to last
                           A  1544    ;  350						state.cycle = READ_
                           A  1545    .line 350
00041F E905003D            A  1546    	LDX	_state+1,#5
                           A  1547    ;  351					}
000423                     A  1548    _6_L_47:
                           A  1549    .line 351
                           A  1550    ;  352					break;
                           A  1551    ;  353				default:
                           A  1552    ;  354					//should not happen
                           A  1553    ;  355					break;
                           A  1554    ;  356			}
                           A  1555    ;  357		}
                           A  1556    ;  358	}
000423                     A  1557    _6_L_52:
                           A  1558    .line 358
000423 D6 0000             A  1559    	CALL	__b_iframereset
000426 BF                  A  1560    	IRET	
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:  31


PC     Object              I  Line    Source i2c.src
                           A  1561    .endfunc "Si2c_Isr",358,"_Si2c_Isr"
                           A  1562    	SEGMENT ROM_DATA
                           A  1563    
                           A  1564    
                           A  1565    ;**************************** _i2cIsDataReady *
                           A  1566    ;Name                         Addr/Register   S
                           A  1567    ;_state                              STATIC    
                           A  1568    
                           A  1569    
                           A  1570    ; Aggregate Stack Size: 0 (words)
                           A  1571    
                           A  1572    
                           A  1573    	.FRAME _n_i2cIsDataReady,?_n_i2cIsDataReady
                           A  1574    	.FRAME _f_i2cIsDataReady,?_f_i2cIsDataReady
                           A  1575    	SEGMENT i2c_TEXT
000427                     A  1576    _i2cIsDataReady:
                           A  1577    .define "_i2cIsDataReady"
                           A  1578    .value _i2cIsDataReady
                           A  1579    .class 2
                           A  1580    .type 66
                           A  1581    .type 0
                           A  1582    .endef
                           A  1583    .begfunc "i2cIsDataReady",370,"_i2cIsDataReady"
000427 D6 0000             A  1584    	CALL	__b_frameset00
                           A  1585    ;  359	
                           A  1586    ;  360	/**************************************
                           A  1587    ;  361	Description:
                           A  1588    ;  362		gives the state of a i2c read
                           A  1589    ;  363	Notes:
                           A  1590    ;  364		is not valid until a i2cStartRead h
                           A  1591    ;  365	Returns:
                           A  1592    ;  366		read;
                           A  1593    ;  367		1 <= done, 0 <= busy , -1 <= failed
                           A  1594    ;  368	***************************************
                           A  1595    ;  369	char i2cIsDataReady(void)
                           A  1596    ;  370	{
                           A  1597    ;  371		return (char) state.reading;
                           A  1598    .line 371
00042A 84003C              A  1599    	LDX	R0,_state
                           A  1600    ;  372	}
                           A  1601    .line 372
00042D D6 0000             A  1602    	CALL	__b_framereset
000430 AF                  A  1603    	RET	
                           A  1604    .endfunc "i2cIsDataReady",372,"_i2cIsDataReady"
                           A  1605    	SEGMENT ROM_DATA
                           A  1606    
                           A  1607    
                           A  1608    ;**************************** _t1_mem_isr *****
                           A  1609    ;Name                         Addr/Register   S
                           A  1610    ;_EI                                 IMPORT  --
                           A  1611    ;_mems_read                          IMPORT  --
                           A  1612    ;_DI                                 IMPORT  --
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:  32


PC     Object              I  Line    Source i2c.src
                           A  1613    
                           A  1614    
                           A  1615    ; Aggregate Stack Size: 0 (words)
                           A  1616    
                           A  1617    
                           A  1618    	.FRAME _n_t1_mem_isr,?_n_t1_mem_isr,RDATA
                           A  1619    	.FCALL _n_mems_read
                           A  1620    	.FRAME _f_t1_mem_isr,?_f_t1_mem_isr,EDATA
                           A  1621    	.FCALL _f_mems_read
                           A  1622    	SEGMENT i2c_TEXT
000431                     A  1623    _t1_mem_isr:
                           A  1624    .define "_t1_mem_isr"
                           A  1625    .value _t1_mem_isr
                           A  1626    .class 2
                           A  1627    .type 65
                           A  1628    .type 0
                           A  1629    .endef
                           A  1630    .begfunc "t1_mem_isr",375,"_t1_mem_isr"
000431 C8FFD0              A  1631    	PUSHX	4093
000434 D6 0000             A  1632    	CALL	__b_iframeset00
                           A  1633    ;  373	
                           A  1634    ;  374	#pragma interrupt
                           A  1635    ;  375	void t1_mem_isr(void){
                           A  1636    ;  376	
                           A  1637    ;  377		DI();
                           A  1638    .line 377
000437 8F                  A  1639    	DI
                           A  1640    ;  378	
                           A  1641    ;  379		mems_read();
                           A  1642    .line 379
000438 D6 00B7             A  1643    	CALL	_mems_read
                           A  1644    ;  380	
                           A  1645    ;  381		EI();
                           A  1646    .line 381
00043B 9F                  A  1647    	EI
                           A  1648    ;  382	// 	printMessage(display, 1);
                           A  1649    ;  383	}
                           A  1650    .line 383
00043C D6 0000             A  1651    	CALL	__b_iframereset
00043F BF                  A  1652    	IRET	
                           A  1653    .endfunc "t1_mem_isr",383,"_t1_mem_isr"
000012 0349                A  1654    	VECTOR	I2C=_Si2c_Isr
                           A  1655    	XREF _printI2CqF:ROM
                           A  1656    	XREF _atan2:ROM
                           A  1657    	XREF _printMessage:ROM
                           A  1658    	XREF __u_stoa:ROM
                           A  1659    	XREF ___print_putromstring:ROM
                           A  1660    	XREF ___print_sputch:ROM
                           A  1661    	XREF ___print_out:EDATA
                           A  1662    	XREF __b_fpadd:ROM
                           A  1663    	XREF __b_fpltof:ROM
                           A  1664    	XREF __b_fpmul:ROM
Zilog Z8 Encore! Macro Assembler Version 2.52 (11010702) 25-Oct-16     19:34:33     page:  33


PC     Object              I  Line    Source i2c.src
                           A  1665    	XREF __b_ucase:ROM
                           A  1666    	XREF __b_framereset:ROM
                           A  1667    	XREF __b_iframereset:ROM
                           A  1668    	XREF __b_frameset0:ROM
                           A  1669    	XREF __b_frameset00:ROM
                           A  1670    	XREF __b_iframeset00:ROM
                           A  1671    	XREF __b_stxlr0:ROM
                           A  1672    	XREF __b_ldxlr0:ROM
                           A  1673    	XREF __b_ldxlr4:ROM
                           A  1674    	XDEF _t1_mem_isr
                           A  1675    	XDEF _i2cIsDataReady
                           A  1676    	XDEF _Si2c_Isr
                           A  1677    	XDEF _complementary
                           A  1678    	XDEF _mems_read
                           A  1679    	XDEF _i2cStartRead
                           A  1680    	XDEF _i2cWrite
                           A  1681    	XDEF _i2cInit
                           A  1682    	XDEF _printI2Cq
                           A  1683    	XDEF _speed
                           A  1684    	XDEF _t1Ready
                           A  1685    	XDEF _gyroZValue
                           A  1686    	XDEF _gyroYValue
                           A  1687    	XDEF _gyroXValue
                           A  1688    	XDEF _accZValue
                           A  1689    	XDEF _accYValue
                           A  1690    	XDEF _accXValue
                           A  1691    	XDEF _gyro_val
                           A  1692    	XDEF _gyro_l
                           A  1693    	XDEF _gyro_h
                           A  1694    	XDEF _acc_x
                           A  1695    	XDEF _acc_y
                           A  1696    	XDEF _acc_yl
                           A  1697    	XDEF _acc_yh
                           A  1698    	XDEF _acc_xl
                           A  1699    	XDEF _acc_xh
                           A  1700    	XDEF _accRead
                           A  1701    	XDEF _gyroRead
                           A  1702    	XDEF _rxFlag
                           A  1703    	XDEF _command
                           A  1704    	XDEF _txFinished
                           A  1705    	XDEF _string
                           A  1706    	XDEF _inChar
                           A  1707    	END


Errors: 0
Warnings: 0
Lines Assembled: 1708
